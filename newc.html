<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Händer & sker – en plats för initiativ</title>
  <meta name="theme-color" content="#0B1220"/>

  <!-- React + Babel UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    html { transition: background-color 0.3s ease; }

    :root{
      /* Bakgrund */
      --page-bg-1:#2b3350;
      --page-bg-2:#222a42;
      --theme-primary-rgb:88,99,199;

      /* Ljus kort-/UI-palett */
      --bg-primary:#F7F8FA;
      --glass-bg:#FFFFFF;
      --glass-border:#E4E6EB;
      --text-primary:#050505;
      --text-secondary:#65676B;
      --danger:#DC2626;
      --shadow-sm:0 1px 2px rgba(0,0,0,.1);
      --shadow-md:0 2px 4px rgba(0,0,0,.1);
      --shadow-lg:0 8px 16px rgba(0,0,0,.15);
      --progress-planeras:#F59E0B;
      --progress-pilot:#3B82F6;
      --progress-driftsatt:#10B981;

      /* Standard (Blå) */
      --theme-primary:#5863C7;
      --theme-primary-dark:#362E7D;
      --theme-primary-light:#91A9FF;
      --theme-tint1:#DBDEF4;
      --theme-tint2:#EFF2FF;
      --card-accent:rgba(88, 99, 199, 0.03);
    }

    /* Teman */
    [data-theme="blue"]{
      --theme-primary:#5863C7; --theme-primary-dark:#362E7D; --theme-primary-light:#91A9FF;
      --theme-tint1:#DBDEF4; --theme-tint2:#EFF2FF; --theme-primary-rgb:88,99,199;
      --page-bg-1:#2b3350; --page-bg-2:#222a42; --bg-primary:#F7F8FA; --glass-bg:#FFFFFF;
      --card-accent:rgba(88, 99, 199, 0.03);
    }
    [data-theme="green"]{
      --theme-primary:#00A78B; --theme-primary-dark:#0F6F60; --theme-primary-light:#7AF3D7;
      --theme-tint1:#D2EFE7; --theme-tint2:#EEFAF7; --theme-primary-rgb:0,167,139;
      --page-bg-1:#274339; --page-bg-2:#1f372e; --bg-primary:#F2FCF9; --glass-bg:#FDFFFE;
      --card-accent:rgba(0, 167, 139, 0.03);
    }
    [data-theme="purple"]{
      --theme-primary:#9D3E9E; --theme-primary-dark:#622977; --theme-primary-light:#F5A7E8;
      --theme-tint1:#ECD8EB; --theme-tint2:#FFF1FE; --theme-primary-rgb:157,62,158;
      --page-bg-1:#3a2a48; --page-bg-2:#2f223b; --bg-primary:#FFF6FD; --glass-bg:#FFFEFF;
      --card-accent:rgba(157, 62, 158, 0.03);
    }
    [data-theme="red"]{
      --theme-primary:#D5422D; --theme-primary-dark:#89281F; --theme-primary-light:#FFA69B;
      --theme-tint1:#FCDBDA; --theme-tint2:#FEEFEE; --theme-primary-rgb:213,66,45;
      --page-bg-1:#442727; --page-bg-2:#362020; --bg-primary:#FFF4F4; --glass-bg:#FFFCFC;
      --card-accent:rgba(213, 66, 45, 0.03);
    }
    [data-theme="gray"]{
      --theme-primary:#48606B; --theme-primary-dark:#2A2F31; --theme-primary-light:#88A8B5;
      --theme-tint1:#DBDFE0; --theme-tint2:#EFF3F4; --theme-primary-rgb:72,96,107;
      --page-bg-1:#2a3239; --page-bg-2:#232a31; --bg-primary:#F6FAFB; --glass-bg:#FAFBFB;
      --card-accent:rgba(72, 96, 107, 0.03);
    }

    /* Bakgrund (temaanpassad) */
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:
        radial-gradient(1100px 520px at 10% -10%, rgba(var(--theme-primary-rgb),0.06), transparent 60%),
        linear-gradient(180deg, var(--page-bg-1), var(--page-bg-2));
      min-height:100vh;
      color:#E9EEF5;
      -webkit-font-smoothing:antialiased;
      overflow-x:hidden;
      transition:background 0.3s ease, color .2s ease;
    }

    /* Korten behåller ljus design */
    .post-card, .login-card, .search-filters, .trash-item, .modal-content, .results-count {
      color: var(--text-primary);
    }

    /* ===== Header ===== */
    .glass-header{
      position:sticky;top:0;max-width:100%;margin:0;padding:12px 16px;background:var(--glass-bg);
      border-bottom:1px solid var(--glass-border);
      display:flex;align-items:center;justify-content:space-between;z-index:100;transition:.3s;
      box-shadow:var(--shadow-sm);
    }
    .glass-header:hover{box-shadow:var(--shadow-md)}
    .logo-area{display:flex;align-items:center;gap:14px;text-decoration:none}
    .logo-img{height:40px;transition:.3s}
    .logo-area:hover .logo-img{transform:scale(1.05)}
    .tagline{font-size:15px;font-weight:600;color:var(--text-secondary)}

    /* Hamburgermeny */
    .hamburger-btn{
      background:var(--bg-primary);
      border:none;
      width:40px;height:40px;border-radius:10px;
      display:grid;place-items:center;
      cursor:pointer;transition:.2s;
      color:var(--text-primary);
      box-shadow:var(--shadow-sm);
    }
    .hamburger-btn:hover{background:#E4E6EB}
    .hamburger-icon{
      width:18px;height:14px;position:relative;
    }
    .hamburger-icon::before,.hamburger-icon::after,.hamburger-icon div{
      content:"";position:absolute;left:0;right:0;height:2px;background:var(--text-primary);border-radius:2px
    }
    .hamburger-icon div{top:6px}
    .hamburger-icon::before{top:0}
    .hamburger-icon::after{bottom:0}

    .menu-overlay{
      position:fixed;inset:0;background:transparent;z-index:120;
    }
    .menu-panel{
      position:absolute;right:8px;top:60px;
      background:var(--glass-bg);
      border:1px solid var(--glass-border);
      border-radius:12px;
      box-shadow:0 10px 24px rgba(0,0,0,.18), 0 2px 6px rgba(0,0,0,.08);
      width:min(92vw, 380px);
      padding:12px;
      z-index:130;
    }
    .menu-section{display:grid;gap:10px;margin:8px 0}
    .menu-row{display:flex;gap:8px;align-items:center}
    .menu-divider{height:1px;background:var(--glass-border);margin:8px 0}
    .menu-label{font-size:12px;color:var(--text-secondary);font-weight:700;text-transform:uppercase;letter-spacing:.06em}

    .user-line{display:flex;align-items:center;gap:10px;padding:8px;border-radius:10px;background:var(--bg-primary)}
    .user-avatar{width:28px;height:28px;border-radius:50%;background:var(--theme-primary);color:#fff;display:grid;place-items:center;font-weight:800}

    /* Tydligare namn i menyn */
    .user-line-name{
      font-weight: 900;
      color: var(--text-primary);
      font-size: 16px;
      letter-spacing: .2px;
    }

    .pill-btn{background:var(--bg-primary);color:var(--text-primary);border:none;padding:10px 12px;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;transition:.2s}
    .pill-btn:hover{background:#E4E6EB}
    .logout-btn:hover{color:var(--danger);background:rgba(220,38,38,.1)}
    .info-btn{background:var(--bg-primary);border:none;width:38px;height:38px;border-radius:10px;display:grid;place-items:center;cursor:pointer;font-size:16px;transition:.2s;color:var(--text-primary)}
    .info-btn:hover{background:#E4E6EB}
    .header-select { width:100%; }

    /* "Nytt inlägg" – tydlig */
    .primary-btn{background:var(--theme-primary);color:#fff;border:none;padding:12px 18px;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;transition:.2s}
    .primary-btn:hover{background:var(--theme-primary-dark)}
    .primary-btn:disabled{opacity:.5;cursor:not-allowed}
    .primary-btn.header-cta{
      display:flex;align-items:center;gap:8px;justify-content:center;
      padding:12px 16px;border-radius:12px;
      box-shadow:0 10px 24px rgba(var(--theme-primary-rgb), .35), 0 2px 6px rgba(0,0,0,.08);
      letter-spacing:.2px;width:100%;
    }
    .primary-btn.header-cta:hover{
      transform:translateY(-1px);
      box-shadow:0 14px 30px rgba(var(--theme-primary-rgb), .45), 0 4px 10px rgba(0,0,0,.10);
    }

    .login-container{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:32px;position:relative;z-index:1}
    .login-card{background:var(--glass-bg);border:1px solid var(--glass-border);border-radius:8px;padding:40px;box-shadow:var(--shadow-lg);text-align:center;max-width:450px;width:100%;transition:.3s}
    .login-card:hover{transform:translateY(-4px);box-shadow:0 12px 24px rgba(0,0,0,.2)}
    .login-logo{height:80px;margin-bottom:16px}
    .login-title{font-size:28px;font-weight:600;color:var(--text-primary);margin-bottom:8px}
    .login-subtitle{font-size:15px;color:var(--text-secondary);margin-bottom:24px}
    .login-form{display:flex;flex-direction:column;gap:16px}
    .form-group{text-align:left}
    .form-label{display:block;font-weight:600;margin-bottom:6px;color:var(--text-primary);font-size:15px}
    .form-input,.search-input,.filter-select,.file-input{
      width:100%;padding:12px 16px;border:1px solid var(--glass-border);border-radius:10px;font-size:15px;background:var(--glass-bg);transition:.2s;font-family:inherit
    }
    textarea.form-input{min-height:120px}
    .form-input:focus,.search-input:focus,.filter-select:focus{outline:none;border-color:var(--theme-primary);background:var(--glass-bg);box-shadow:0 0 0 2px rgba(var(--theme-primary-rgb),.1)}
    .form-input.otp-input{text-align:center;font-size:24px;letter-spacing:8px;font-weight:600}
    .secondary-btn{background:var(--bg-primary);color:var(--text-primary);border:none;padding:12px 18px;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;transition:.2s}
    .secondary-btn:hover{background:#E4E6EB}
    .success-message{background:#D4F4E7;color:#065F46;padding:12px;border-radius:10px;margin-bottom:12px;font-size:15px;font-weight:600}
    .error-message{background:#FEE2E2;color:var(--danger);padding:12px;border-radius:10px;margin-bottom:12px;font-size:15px;font-weight:600}

    .loader{display:flex;flex-direction:column;align-items:center;gap:12px;padding:40px}
    .spinner{width:32px;height:32px;border-radius:50%;border:3px solid var(--glass-border);border-top-color:var(--theme-primary);animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .loader-text{color:#CBD5E1;font-size:15px;text-align:center;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);padding:8px 12px;border-radius:10px}

    /* Huvudlayout */
    .main-container{
      max-width:1200px;
      margin:0 auto;
      padding:16px 16px 80px;
      position:relative;
      z-index:1;
    }

    .search-filters{
      background:linear-gradient(to bottom, var(--glass-bg), var(--glass-bg)),
                 linear-gradient(135deg, var(--card-accent), transparent);
      background-blend-mode:normal;border:1px solid var(--glass-border);
      border-radius:12px;padding:16px;box-shadow:var(--shadow-sm);margin-bottom:16px
    }
    .search-row{display:grid;grid-template-columns:1fr 220px 220px auto;gap:12px;align-items:end}
    .clear-btn{background:var(--theme-primary);color:#fff;border:none;padding:12px 16px;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;transition:.2s}
    .clear-btn:hover{background:var(--theme-primary-dark)}
    .results-count{text-align:center;color:var(--text-secondary);font-size:15px;margin:16px 0;background:var(--glass-bg);border:1px solid var(--glass-border);display:inline-block;padding:12px 16px;border-radius:12px;width:100%}

    /* LIST-LAYOUTER */
    .posts-grid{margin-top:0}
    .posts-grid.stacked{display:flex;flex-direction:column;gap:16px}
    .posts-grid.grid{display:grid;gap:16px;grid-template-columns:repeat(3, 1fr)}
    @media (max-width:1024px){.posts-grid.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:640px){.posts-grid.grid{grid-template-columns:1fr}}

    /* Kort */
    .post-card{
      background:linear-gradient(to bottom, var(--glass-bg), var(--glass-bg)),
                 linear-gradient(135deg, var(--card-accent), transparent);
      background-blend-mode:normal;border:1px solid var(--glass-border);
      border-radius:12px;padding:0;box-shadow:var(--shadow-sm);
      display:flex;flex-direction:column;min-height:auto;transition:.2s
    }
    .post-card:hover{box-shadow:var(--shadow-md)}
    .post-header{display:flex;gap:12px;align-items:center;margin-bottom:0;padding:12px 16px}
    .post-avatar{width:40px;height:40px;border-radius:50%;background:var(--theme-primary);color:#fff;display:grid;place-items:center;font-weight:600;font-size:16px}
    .post-meta{display:grid;gap:4px;flex:1}
    .post-title{font-size:18px;letter-spacing:0;font-weight:600;color:var(--text-primary);padding:0 16px 8px}
    .post-author-info{display:flex;gap:8px;align-items:center;flex-wrap:wrap;color:var(--text-secondary);font-size:13px}
    .category-badge{padding:3px 8px;border-radius:4px;color:#fff;font-size:12px;font-weight:600}
    .post-summary{margin:0;padding:0 16px 12px;color:var(--text-primary);line-height:1.5;letter-spacing:0;font-size:15px}

    .post-actions{display:flex;align-items:center;gap:4px;margin-top:auto;padding:4px 0 0;border-top:1px solid var(--glass-border)}
    .action-btn{background:transparent;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:15px;font-weight:600;transition:.2s;flex:1;color:var(--text-secondary)}
    .action-btn:hover{background:var(--bg-primary)}
    .action-btn.liked{color:var(--theme-primary)}
    .comment-count{color:var(--text-secondary);font-size:15px;padding:8px 12px;font-weight:600}
    .delete-btn{border:none;color:var(--danger);background:var(--bg-primary);padding:6px 10px;border-radius:8px;font-size:20px;line-height:1}
    .delete-btn:hover{background:#E4E6EB}
    .edit-btn{border:none;color:var(--theme-primary);background:var(--bg-primary);padding:6px 10px;border-radius:8px;font-size:16px;line-height:1}
    .edit-btn:hover{background:#E4E6EB}

    .progress-wrap{display:flex;align-items:center;gap:8px;margin:0;padding:8px 16px 12px;border-top:none}
    .progress-chip{font-size:12px;font-weight:700;padding:4px 8px;border-radius:6px;color:#fff;border:none;background:#111827}
    .progress-bar{flex:1;height:10px;background:var(--bg-primary);border-radius:999px;overflow:hidden}
    .progress-stages{display:flex;height:100%}
    .progress-stage{flex:1;opacity:.3;transition:.2s}
    .progress-stage.planeras{background:var(--progress-planeras)}
    .progress-stage.pilot{background:var(--progress-pilot)}
    .progress-stage.driftsatt{background:var(--progress-driftsatt)}
    .progress-stage.active{opacity:1}

    .modal-overlay{position:fixed;inset:0;background:rgba(255,255,255,.8);display:grid;place-items:center;z-index:200;backdrop-filter:blur(4px)}
    .modal-content{width:min(700px,92vw);background:var(--glass-bg);border-radius:12px;overflow:hidden;box-shadow:0 12px 28px rgba(0,0,0,.15);max-height:90vh;display:flex;flex-direction:column}
    .modal-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--glass-border)}
    .modal-title{font-size:20px;font-weight:700;color:var(--text-primary)}
    .modal-close{border:none;background:var(--bg-primary);font-size:24px;cursor:pointer;color:var(--text-secondary);line-height:1;padding:0;width:40px;height:40px;border-radius:10px;display:grid;place-items:center;transition:.2s}
    .modal-close:hover{background:#E4E6EB}
    .modal-body{padding:20px;overflow-y:auto}
    .confirm-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:20px}
    .danger-btn{background:var(--danger);color:var(--fff);border:none;padding:10px 16px;border-radius:10px;cursor:pointer;font-weight:700;font-size:15px;transition:.2s}
    .danger-btn:hover{background:#b91c1c}
    .ghost-btn{background:var(--bg-primary);border:none;padding:10px 16px;border-radius:10px;cursor:pointer;font-weight:700;font-size:15px;color:var(--text-primary);transition:.2s}
    .ghost-btn:hover{background:#E4E6EB}

    .trash-list{display:grid;gap:10px}
    .trash-item{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center;border:1px solid var(--glass-border);border-radius:10px;padding:12px;background:var(--glass-bg)}
    .small-muted{font-size:13px;color:var(--text-secondary);margin-top:4px}

    .charline{display:flex;justify-content:space-between;font-size:13px;color:var(--text-secondary);margin-top:6px}

    .post-detail-modal .modal-body{max-height:70vh;overflow-y:auto}
    .post-detail-content{line-height:1.6;white-space:pre-wrap;color:var(--text-primary);font-size:15px}
    .post-detail-meta{padding:16px;background:var(--bg-primary);border-radius:12px;margin-bottom:16px;display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    .post-detail-images{display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;margin:16px 0}
    .post-detail-image{width:100%;border-radius:12px;cursor:pointer;transition:.2s}
    .post-detail-image:hover{transform:scale(1.02);box-shadow:var(--shadow-md)}

    .progress-selector{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
    .progress-option{padding:12px;border:2px solid var(--glass-border);border-radius:10px;text-align:center;cursor:pointer;transition:.2s;font-weight:700;font-size:15px}
    .progress-option:hover{border-color:var(--theme-primary);background:var(--theme-tint2)}
    .progress-option.selected{border-color:currentColor;background:currentColor;color:#fff}
    .progress-option.planeras{color:var(--progress-planeras)}
    .progress-option.pilot{color:var(--progress-pilot)}
    .progress-option.driftsatt{color:var(--progress-driftsatt)}

    .info-banner{background:#FEF3C7;border:1px solid #F59E0B;border-radius:12px;padding:16px;margin-bottom:16px;color:#78350F}
    .info-banner-title{display:flex;align-items:center;gap:8px;font-size:17px;font-weight:700;color:#92400E;margin-bottom:8px}
    .info-banner-text{font-size:15px;line-height:1.6;margin-bottom:6px}
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef } = React;

    /* =======================
       KONFIG
       ======================= */
    const CONFIG = {
      API_URL: 'https://script.google.com/macros/s/AKfycbw7OvdjygHoFhu_Z1HAapi0bt7Ra7KbaoWDPfDgD1Cy-82IxJQ0s-t4lji9bPdCdvI/exec',
      ALLOWED_EMAIL_DOMAIN: 'karlskoga.se',
      STORAGE_KEY: 'karlskoga_session',
      LOGO_SRC: './hander_och_sker.png'
    };

    /* Progress-steg */
    const PROGRESS_STAGES = {
      planeras: { label: 'Planeras', color: '#F59E0B', icon: '📋' },
      pilot: { label: 'Pilot', color: '#3B82F6', icon: '🧪' },
      driftsatt: { label: 'Driftsatt', color: '#10B981', icon: '✅' }
    };

    /* ===== API-klient ===== */
    const api = {
      async get(path, params = {}) {
        const url = new URL(CONFIG.API_URL);
        url.searchParams.set('path', path);
        Object.entries(params).forEach(([k, v]) => {
          if (v !== null och v !== undefined) url.searchParams.set(k, String(v));
        });
        const res = await fetch(url.toString(), { method: 'GET', redirect: 'follow' });
        const text = await res.text();
        let json;
        try { json = JSON.parse(text); } catch {
          console.warn('GET non-JSON', { path, text });
          throw new Error('API svarade inte med JSON');
        }
        return json;
      },
      async post(path, data = {}) {
        const form = new URLSearchParams();
        form.set('path', path);
        Object.entries(data).forEach(([k, v]) => {
          if (v !== null && v !== undefined) form.append(k, String(v));
        });
        const res = await fetch(CONFIG.API_URL, {
          method: 'POST',
          body: form,
          redirect: 'follow',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
        });
        const text = await res.text();
        let json;
        try { json = JSON.parse(text); } catch {
          console.warn('POST non-JSON', { path, text });
          throw new Error('API svarade inte med JSON');
        }
        return json;
      }
    };

    /* ===== UTIL ===== */
    const isAllowedEmail = (email) => {
      if (!email) return false;
      const e = String(email).trim().toLowerCase();
      return e.endsWith('@' + CONFIG.ALLOWED_EMAIL_DOMAIN) && e.split('@')[0].includes('.');
    };
    const firstNameFromEmail = (email) => {
      if (!email) return '';
      const local = String(email).split('@')[0] || '';
      const first = (local.split('.')[0] || local).replace(/[_-]+/g, ' ');
      return first.charAt(0).toUpperCase() + first.slice(1).toLowerCase();
    };
    const clamp = (s='', n=140) => s.length <= n ? s : s.slice(0, n-1) + '…';

    // NYTT: Fullständigt namn (Förnamn Efternamn) från e-post
    const fullNameFromEmail = (email) => {
      const cap = (s) => s ? s.charAt(0).toUpperCase() + s.slice(1).toLowerCase() : '';
      const local = String(email || '').split('@')[0] || '';
      const parts = local.split(/[._-]+/).filter(Boolean);
      if (parts.length >= 2) {
        return `${cap(parts[0])} ${cap(parts[1])}`;
      }
      return cap(parts[0] || '');
    };

    /* ===== Progress Bar ===== */
    function ProgressBar({ progress }) {
      const stages = ['planeras', 'pilot', 'driftsatt'];
      const currentIndex = Math.max(0, stages.indexOf(progress || 'planeras'));
      const chipText = PROGRESS_STAGES[stages[currentIndex]]?.label || 'Planeras';
      return (
        <div className="progress-wrap">
          <span className="progress-chip">{chipText}</span>
          <div className="progress-bar">
            <div className="progress-stages">
              {stages.map((stage, idx) => (
                <div
                  key={stage}
                  className={`progress-stage ${stage} ${idx <= currentIndex ? 'active' : ''}`}
                  title={PROGRESS_STAGES[stage].label}
                />
              ))}
            </div>
          </div>
        </div>
      );
    }

    /* ===== Progress Selector ===== */
    function ProgressSelector({ value, onChange }) {
      return (
        <div>
          <label className="form-label">Status</label>
          <div className="progress-selector">
            {Object.entries(PROGRESS_STAGES).map(([key, stage]) => (
              <div
                key={key}
                className={`progress-option ${key} ${value === key ? 'selected' : ''}`}
                onClick={() => onChange(key)}
              >
                {stage.icon} {stage.label}
              </div>
            ))}
          </div>
        </div>
      );
    }

    /* ===== Loader ===== */
    function Loader({ text="Laddar..." }) {
      return (
        <div className="loader">
          <div className="spinner"></div>
          <div className="loader-text">{text}</div>
        </div>
      );
    }

    /* ===== Modal-komponenter ===== */
    function Modal({ isOpen, onClose, title, children }) {
      if (!isOpen) return null;
      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal-content" onClick={(e)=>e.stopPropagation()}>
            <div className="modal-header">
              <h2 className="modal-title">{title}</h2>
              <button className="modal-close" onClick={onClose}>×</button>
            </div>
            <div className="modal-body">{children}</div>
          </div>
        </div>
      );
    }

    function ConfirmModal({ isOpen, title="Bekräfta", message, confirmText="OK", cancelText="Avbryt", onConfirm, onCancel }) {
      return (
        <Modal isOpen={isOpen} onClose={onCancel} title={title}>
          <p style={{marginBottom:20}}>{message}</p>
          <div className="confirm-actions">
            <button className="ghost-btn" onClick={onCancel}>{cancelText}</button>
            <button className="danger-btn" onClick={onConfirm}>{confirmText}</button>
          </div>
        </Modal>
      );
    }

    function InfoModal({ isOpen, onClose, showEmailInfo = false }) {
      return (
        <Modal isOpen={isOpen} onClose={onClose} title="ℹ️ Om den här sidan">
          <div className="info-modal-content">
            <p><strong>Detta är ett proof of concept</strong> – en testversion av en plattform för att dela initiativ.</p>
            <div className="info-banner">
              <div className="info-banner-title">⚠️ Viktig information om data</div>
              <div className="info-banner-text">All information som skrivs här (inlägg, kommentarer, reaktioner) samt uppgifter om vem som skriver lagras för demo/test.</div>
            </div>
            {showEmailInfo && (
              <div className="info-banner" style="background:#E0E7FF;border-color:#C7D2FE;color:#1e1b4b">
                <div className="info-banner-title" style="color:#4338CA">📧 Om inloggningskoden</div>
                <div className="info-banner-text">Koden skickas via e-post och innehåller endast en 6-siffrig kod – inga länkar.</div>
              </div>
            )}
          </div>
        </Modal>
      );
    }

    /* ===== Login ===== */
    function LoginPage({ onLogin }) {
      const [email,setEmail] = useState('');
      const [otpSent,setOtpSent] = useState(false);
      const [otp,setOtp] = useState('');
      const [loading,setLoading] = useState(false);
      const [error,setError] = useState('');
      const [showInfo, setShowInfo] = useState(false);

      const requestOTP = async (e) => {
        e.preventDefault();
        const normalized = (email||'').trim().toLowerCase();
        if (!isAllowedEmail(normalized)) {
          setError(`Ange en giltig @${CONFIG.ALLOWED_EMAIL_DOMAIN}-adress (t.ex. fornamn.efternamn@${CONFIG.ALLOWED_EMAIL_DOMAIN})`);
          return;
        }
        setLoading(true); setError('');
        try {
          const res = await api.post('auth/request-otp', { email: normalized });
          if (!res.success) throw new Error(res.error || 'Kunde inte skicka kod');
          setOtpSent(true);
        } catch (err) { setError(err.message); } finally { setLoading(false); }
      };

      const verifyOTP = async (e) => {
        e.preventDefault();
        setLoading(true); setError('');
        try {
          const normalized = (email||'').trim().toLowerCase();
          const res = await api.post('auth/verify-otp', { email: normalized, code: otp });
          if (!res.success) throw new Error(res.error || 'Ogiltig kod');
          onLogin({ email: res.email, sessionToken: res.sessionToken, displayName: firstNameFromEmail(res.email) });
        } catch (err) { setError(err.message); } finally { setLoading(false); }
      };

      return (
        <div className="login-container">
          <div className="login-card">
            <img src={CONFIG.LOGO_SRC} alt="Portal" className="login-logo"/>
            <h1 className="login-title">platsen där initiativ synliggörs</h1>
            <p className="login-subtitle">Logga in med din @{CONFIG.ALLOWED_EMAIL_DOMAIN}-adress</p>

            <div className="info-banner">
              <div className="info-banner-title">ℹ️ Proof of Concept</div>
              <div className="info-banner-text">Detta är en testversion. Data lagras för demonstrationssyfte.</div>
              <button 
                onClick={() => setShowInfo(true)}
                style={{background:'transparent',border:'none',color:'#92400E',textDecoration:'underline',cursor:'pointer',fontSize:13,fontWeight:800,padding:0,marginTop:4}}
              >
                Läs mer →
              </button>
            </div>

            {!otpSent ? (
              <form onSubmit={requestOTP} className="login-form">
                {error && <div className="error-message">{error}</div>}
                <div className="form-group">
                  <label className="form-label">E-postadress</label>
                  <input
                    type="email"
                    className="form-input"
                    placeholder={`fornamn.efternamn@${CONFIG.ALLOWED_EMAIL_DOMAIN}`}
                    value={email}
                    onChange={(e)=>setEmail(e.target.value)}
                    required
                  />
                </div>
                <button type="submit" disabled={loading} className="primary-btn">
                  {loading?'Skickar…':'Skicka inloggningskod'}
                </button>
              </form>
            ) : (
              <form onSubmit={verifyOTP} className="login-form">
                {error && <div className="error-message">{error}</div>}
                <div className="success-message">Kod skickad till {email}</div>
                <div className="form-group">
                  <label className="form-label">Ange kod</label>
                  <input className="form-input otp-input" placeholder="123456" value={otp}
                         onChange={(e)=>setOtp(e.target.value)} maxLength="6" inputMode="numeric" required/>
                </div>
                <button type="submit" disabled={loading} className="primary-btn">
                  {loading?'Verifierar…':'Logga in'}
                </button>
                <button type="button" onClick={()=>setOtpSent(false)} className="secondary-btn">Skicka ny kod</button>
              </form>
            )}
          </div>

          <InfoModal isOpen={showInfo} onClose={() => setShowInfo(false)} showEmailInfo={true} />
        </div>
      );
    }

    /* ===== Filter ===== */
    function SearchFilters({ searchQuery,setSearchQuery, categoryFilter,setCategoryFilter, authorFilter,setAuthorFilter, categories, onClear }) {
      return (
        <div className="search-filters">
          <div className="search-row">
            <div className="form-group">
              <label className="form-label">Sök i inlägg</label>
              <input type="text" value={searchQuery} onChange={(e)=>setSearchQuery(e.target.value)} className="search-input" placeholder="Sök efter titel eller innehåll…"/>
            </div>
            <div className="form-group">
              <label className="form-label">Kategori</label>
              <select value={categoryFilter} onChange={(e)=>setCategoryFilter(e.target.value)} className="filter-select">
                <option value="all">Alla kategorier</option>
                {categories.map(cat=>(
                  <option key={cat.category_id} value={cat.category_id}>{cat.name} ({cat.post_count||0})</option>
                ))}
              </select>
            </div>
            <div className="form-group">
              <label className="form-label">Författare</label>
              <input type="text" value={authorFilter} onChange={(e)=>setAuthorFilter(e.target.value)} className="search-input" placeholder="Filtrera på användare…"/>
            </div>
            <button onClick={onClear} className="clear-btn">Rensa</button>
          </div>
        </div>
      );
    }

    /* ===== Skapa/Redigera inlägg ===== */
    function CreateEditPostModal({ isOpen, onClose, session, onSuccess, editPost = null }) {
      const [title,setTitle] = useState('');
      const [summary,setSummary] = useState('');
      const [text,setText] = useState('');
      const [categoryId,setCategoryId] = useState('general');
      const [externalLink,setExternalLink] = useState('');
      const [progress,setProgress] = useState('planeras');
      const [categories,setCategories] = useState([]);
      const [loading,setLoading] = useState(false);
      const [error,setError] = useState('');

      const isEditing = !!editPost;

      useEffect(()=>{ 
        if(isOpen) {
          loadCategories();
          if (editPost) {
            setTitle(editPost.title || '');
            setSummary(editPost.summary || '');
            setText(editPost.text || '');
            setCategoryId(editPost.category_id || 'general');
            setExternalLink(editPost.external_link || '');
            setProgress(editPost.progress || 'planeras');
          } else {
            setTitle(''); setSummary(''); setText(''); setCategoryId('general'); setExternalLink(''); setProgress('planeras');
          }
        }
      },[isOpen, editPost]);

      const loadCategories = async () => {
        try {
          const res = await api.get('categories', { session: session.sessionToken });
          if (res.success) setCategories(res.categories || []);
          else setError(res.error || 'Kunde inte hämta kategorier');
        } catch(e){
          setError('Kunde inte hämta kategorier');
        }
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!summary.trim()) { setError('Sammanfattning krävs (max 140 tecken)'); return; }
        setLoading(true); setError('');
        try {
          const data = { session: session.sessionToken, title, summary, text, categoryId, externalLink: externalLink.trim(), progress };
          const result = isEditing 
            ? await api.post('post/update', { ...data, postId: editPost.post_id })
            : await api.post('post/create', data);
          if (!result.success) throw new Error(result.error || 'Kunde inte spara inlägg');

          setTitle(''); setSummary(''); setText(''); setCategoryId('general'); setExternalLink(''); setProgress('planeras');
          onSuccess && onSuccess(); onClose();
        } catch (err) { setError(err.message); } finally { setLoading(false); }
      };

      const left = 140 - (summary?.length||0);

      return (
        <Modal isOpen={isOpen} onClose={onClose} title={isEditing ? 'Redigera inlägg' : 'Nytt inlägg'}>
          {error && <div className="error-message">{error}</div>}
          <form onSubmit={handleSubmit}>
            <div className="form-group">
              <label className="form-label">Rubrik</label>
              <input type="text" className="form-input" placeholder="Ange en beskrivande rubrik…" value={title} onChange={(e)=>setTitle(e.target.value)} required/>
            </div>

            <div className="form-group" style={{marginTop:16}}>
              <label className="form-label">Kategori</label>
              <select value={categoryId} onChange={(e)=>setCategoryId(e.target.value)} className="filter-select">
                {categories.map(cat => <option key={cat.category_id} value={cat.category_id}>{cat.name}</option>)}
              </select>
            </div>

            <div className="form-group" style={{marginTop:16}}>
              <label className="form-label">Sammanfattning (max 140 tecken)</label>
              <input type="text" className="form-input" value={summary} onChange={(e)=>setSummary(clamp(e.target.value, 140))} placeholder="Kort teaser till startsidan…" required />
              <div className="charline"><span>Förhandsvisas på startsidan</span><span>{left} tecken kvar</span></div>
            </div>

            <div className="form-group" style={{marginTop:16}}>
              <label className="form-label">Huvudtext</label>
              <textarea className="form-input" value={text} onChange={(e)=>setText(e.target.value)} placeholder="Beskriv idén eller lösningen…" required />
            </div>

            <div className="form-group" style={{marginTop:16}}>
              <label className="form-label">Extern länk (valfritt)</label>
              <input type="url" className="form-input" value={externalLink} onChange={(e)=>setExternalLink(e.target.value)} placeholder="https://exempel.se/dokument" />
              <div className="small-muted">Lägg till en länk till dokument, webbsida eller annan resurs</div>
            </div>

            <div className="form-group" style={{marginTop:16}}>
              <ProgressSelector value={progress} onChange={setProgress} />
            </div>

            <div style={{display:'flex',justifyContent:'flex-end',gap:12,marginTop:20}}>
              <button type="button" onClick={onClose} className="ghost-btn">Avbryt</button>
              <button type="submit" disabled={loading} className="primary-btn">
                {loading ? (isEditing ? 'Sparar…' : 'Publicerar…') : (isEditing ? 'Spara ändringar' : 'Publicera')}
              </button>
            </div>
          </form>
        </Modal>
      );
    }

    /* ===== Reaktioner ===== */
    function ReactionBar({ post, session, onUpdate }) {
      const [count,setCount] = useState(0);
      const [hasLiked,setHasLiked] = useState(false);
      const [busy,setBusy] = useState(false);

      const load = useCallback(async ()=>{
        const res = await api.get('post/reactions',{ postId: post.post_id, session: session.sessionToken });
        if (res.success) {
          setCount((res.counts && res.counts.like) || 0);
          setHasLiked((res.reactions||[]).some(r => String(r.user_email).toLowerCase()===String(session.email).toLowerCase() && r.type==='like'));
        }
      },[post.post_id,session.email,session.sessionToken]);

      useEffect(()=>{ load(); },[load]);

      const toggle = async ()=>{
        setBusy(true);
        try{
          if(hasLiked) await api.post('post/reaction/remove',{ session: session.sessionToken, postId: post.post_id });
          else await api.post('post/reaction/add',{ session: session.sessionToken, postId: post.post_id, type:'like' });
          await load(); onUpdate && onUpdate();
        } finally { setBusy(false); }
      };

      return (
        <button onClick={toggle} disabled={busy} className={`action-btn ${hasLiked?'liked':''}`}>
          {hasLiked?'❤️':'♡'} {count}
        </button>
      );
    }

    /* ===== Post-detalj ===== */
    function PostDetailModal({ isOpen, onClose, post, session, onEdit }) {
      const [comments, setComments] = useState([]);
      const [commentText, setCommentText] = useState('');
      const [loadingComments, setLoadingComments] = useState(false);
      const [submitting, setSubmitting] = useState(false);

      useEffect(() => { if (isOpen && post) loadComments(); }, [isOpen, post]);

      const loadComments = async () => {
        if (!post) return;
        setLoadingComments(true);
        try {
          const res = await api.get('post/comments', { postId: post.post_id, session: session.sessionToken });
          if (res.success) setComments(res.comments || []);
        } catch (err) { console.error('Kunde inte ladda kommentarer:', err); }
        finally { setLoadingComments(false); }
      };

      const submitComment = async (e) => {
        e.preventDefault();
        if (!commentText.trim()) return;
        setSubmitting(true);
        try {
          const res = await api.post('post/comment/add', { session: session.sessionToken, postId: post.post_id, text: commentText });
          if (res.success) { setCommentText(''); await loadComments(); }
          else alert('Kunde inte skicka kommentar: ' + (res.error || 'Okänt fel'));
        } catch (err) { alert('Fel vid kommentering: ' + err.message); }
        finally { setSubmitting(false); }
      };

      if (!post) return null;

      const isAuthor = String(post.author_email||'').toLowerCase() === String(session.email||'').toLowerCase();

      return (
        <Modal isOpen={isOpen} onClose={onClose} title={post.title || '(utan rubrik)'}>
          <div className="post-detail-meta">
            <div className="post-avatar" style={{width:48,height:48,fontSize:18}}>
              {(post.author_email||'?')[0].toUpperCase()}
            </div>
            <div style={{flex:1}}>
              <div style={{fontWeight:800,marginBottom:4}}>{firstNameFromEmail(post.author_email)}</div>
              <div style={{fontSize:13,color:'var(--text-secondary)'}}>{new Date(post.created_at).toLocaleString('sv-SE')}</div>
            </div>
            {post.category && (
              <div className="category-badge" style={{ backgroundColor: post.category.color || '#6B7280' }}>
                {post.category.name}
              </div>
            )}
            {isAuthor && (
              <button className="pill-btn edit-btn" onClick={() => { onClose(); onEdit(post); }} style={{marginLeft:8}}>✏️ Redigera</button>
            )}
          </div>

          {post.summary && (
            <div style={{background:'linear-gradient(135deg, #E8ECFF, #F0F4FF)',padding:16,borderRadius:12,marginBottom:16,fontWeight:700,color:'#1F2937'}}>
              {post.summary}
            </div>
          )}

          <div className="post-detail-content">{post.text}</div>

          {post.images && post.images.length > 0 && (
            <div className="post-detail-images">
              {post.images.map((img, idx) => (
                <img key={idx} src={img.thumbnailUrl} alt={`Bild ${idx+1}`} className="post-detail-image" onClick={() => window.open(img.fullUrl, '_blank')} />
              ))}
            </div>
          )}

          {post.external_link && String(post.external_link).trim() && (
            <div style={{marginTop:16,padding:16,background:'linear-gradient(135deg, #E0E7FF, #EEF2FF)',borderRadius:12,border:'1px solid #C7D2FE'}}>
              <div style={{fontSize:13,fontWeight:800,color:'#4338CA',marginBottom:8,display:'flex',alignItems:'center',gap:6}}>🔗 Extern länk</div>
              <a href={post.external_link} target="_blank" rel="noopener noreferrer" style={{color:'#5B21B6',fontWeight:800,textDecoration:'none',wordBreak:'break-all',fontSize:14}}
                onMouseOver={(e) => e.target.style.textDecoration = 'underline'}
                onMouseOut={(e) => e.target.style.textDecoration = 'none'}
              >
                {post.external_link}
              </a>
            </div>
          )}

          <div style={{marginTop:16}}><ProgressBar progress={post.progress || 'planeras'} /></div>

          <div style={{marginTop:24,paddingTop:16,borderTop:'1px solid #e5e7eb'}}>
            <ReactionBar post={post} session={session}/>
          </div>

          <div style={{marginTop:24,paddingTop:20,borderTop:'1px solid #e5e7eb'}}>
            <h3 style={{fontSize:16,fontWeight:800,marginBottom:16,display:'flex',alignItems:'center',gap:8}}>
              💬 Kommentarer
              <span style={{fontSize:14,fontWeight:400,color:'var(--text-secondary)'}}>({comments.length})</span>
            </h3>

            {loadingComments ? (
              <div style={{textAlign:'center',padding:20,color:'var(--text-secondary)'}}>Laddar kommentarer...</div>
            ) : comments.length === 0 ? (
              <div style={{textAlign:'center',padding:20,color:'var(--text-secondary)',fontSize:14}}>Inga kommentarer ännu. Var först att kommentera!</div>
            ) : (
              <div style={{marginBottom:16}}>
                {comments.map(comment => (
                  <div key={comment.comment_id} style={{background:'rgba(249,250,251,0.95)',border:'1px solid #e5e7eb',borderRadius:12,padding:12,marginBottom:10}}>
                    <div style={{display:'flex',gap:8,alignItems:'center',marginBottom:6,fontSize:12,color:'var(--text-secondary)'}}>
                      <div style={{width:24,height:24,borderRadius:'50%',background:'#e5e7eb',display:'grid',placeItems:'center',fontSize:11,fontWeight:800,color:'#111827'}}>{(comment.user_email||'?')[0].toUpperCase()}</div>
                      <span style={{fontWeight:800,color:'#1F2937'}}>{firstNameFromEmail(comment.user_email)}</span>
                      <span>•</span>
                      <span>{new Date(comment.created_at).toLocaleString('sv-SE')}</span>
                    </div>
                    <div style={{paddingLeft:32,color:'#1F2937',lineHeight:1.6,whiteSpace:'pre-wrap'}}>{comment.text}</div>
                  </div>
                ))}
              </div>
            )}

            <form onSubmit={submitComment} style={{display:'flex',gap:8,marginTop:12}}>
              <input type="text" value={commentText} onChange={(e) => setCommentText(e.target.value)} placeholder="Skriv en kommentar..." disabled={submitting}
                style={{flex:1,padding:'10px 14px',border:'1px solid rgba(0,0,0,.12)',borderRadius:10,fontSize:14,background:'rgba(255,255,255,.98)',transition:'0.2s'}}
                onFocus={(e) => { e.target.style.borderColor = '#5863C7'; e.target.style.boxShadow = '0 0 0 3px rgba(88,99,199,.15)'; }}
                onBlur={(e) => { e.target.style.borderColor = 'rgba(0,0,0,.12)'; e.target.style.boxShadow = 'none'; }}
              />
              <button type="submit" disabled={!commentText.trim() || submitting}
                style={{border:'none',padding:'10px 16px',borderRadius:10,background: commentText.trim() && !submitting ? '#5863C7' : '#d1d5db',color:'#fff',fontWeight:800,cursor: commentText.trim() && !submitting ? 'pointer' : 'not-allowed',fontSize:14,transition:'0.2s'}}
              >
                {submitting ? 'Skickar...' : 'Skicka'}
              </button>
            </form>
          </div>
        </Modal>
      );
    }

    /* ===== Papperskorg ===== */
    function TrashModal({ isOpen, onClose, session, onChanged }) {
      const [loading,setLoading] = useState(true);
      const [items,setItems] = useState([]);
      const [error,setError] = useState('');
      
      const loadTrash = async ()=>{
        setLoading(true); setError('');
        try{
          const res = await api.get('posts/trash', { session: session.sessionToken });
          if(!res.success) throw new Error(res.error||'Kunde inte hämta papperskorg');
          setItems(res.posts||[]);
        }catch(err){ setError(err.message); } finally { setLoading(false); }
      };
      
      useEffect(()=>{ if(isOpen) loadTrash(); },[isOpen]);

      const restore = async (postId)=>{
        try{ 
          const res = await api.post('post/restore',{ session: session.sessionToken, postId });
          if(!res.success) throw new Error(res.error||'Kunde inte återställa');
          await loadTrash(); onChanged && onChanged();
        }catch(err){ alert(err.message); }
      };
      
      const purge = async (postId)=>{
        if(!confirm('Radera permanent? Detta går inte att ångra.')) return;
        try{ 
          const res = await api.post('post/purge',{ session: session.sessionToken, postId });
          if(!res.success) throw new Error(res.error||'Kunde inte radera permanent');
          await loadTrash(); onChanged && onChanged();
        }catch(err){ alert(err.message); }
      };

      return (
        <Modal isOpen={isOpen} onClose={onClose} title="Papperskorg">
          {error && <div className="error-message">{error}</div>}
          {loading ? <Loader text="Hämtar papperskorg…"/> :
           items.length===0 ? <div className="loader-text">Papperskorgen är tom.</div> :
           <div className="trash-list">
            {items.map(p=>(
              <div key={p.post_id} className="trash-item">
                <div>
                  <div><strong>{p.title || '(utan rubrik)'}</strong></div>
                  <div className="small-muted">Av {firstNameFromEmail(p.author_email)} • {new Date(p.deleted_at||p.created_at).toLocaleString('sv-SE')}</div>
                </div>
                <button className="pill-btn" onClick={()=>restore(p.post_id)}>Återställ</button>
                <button className="pill-btn delete-btn" onClick={()=>purge(p.post_id)}>Radera permanent</button>
              </div>
            ))}
           </div>}
        </Modal>
      );
    }

    /* ===== Dropdown: Tema ===== */
    function ThemeDropdown(){
      const [currentTheme, setCurrentTheme] = useState(() => {
        const saved = localStorage.getItem('siteTheme') || 'blue';
        document.documentElement.setAttribute('data-theme', saved);
        return saved;
      });

      const changeTheme = (themeId) => {
        setCurrentTheme(themeId);
        localStorage.setItem('siteTheme', themeId);
        document.documentElement.setAttribute('data-theme', themeId);
        window.getComputedStyle(document.documentElement).getPropertyValue('--page-bg-1');
      };

      return (
        <select
          className="filter-select header-select"
          value={currentTheme}
          onChange={(e)=>changeTheme(e.target.value)}
          title="Välj tema"
        >
          <option value="blue">Tema: Blå</option>
          <option value="green">Tema: Grön</option>
          <option value="purple">Tema: Lila</option>
          <option value="red">Tema: Röd</option>
          <option value="gray">Tema: Grå</option>
        </select>
      );
    }

    /* ===== Dropdown: Layout ===== */
    function LayoutDropdown({ layout, onChange }){
      return (
        <select
          className="filter-select header-select"
          value={layout}
          onChange={(e)=>onChange(e.target.value)}
          title="Välj layout för inlägg"
        >
          <option value="stacked">Layout: Staplad</option>
          <option value="grid">Layout: Grid</option>
        </select>
      );
    }

    /* ===== HeaderMenu (hamburger) ===== */
    function HeaderMenu({
      session,
      onNewPost,
      onShowInfo,
      onShowTrash,
      onLogout,
      layoutMode,
      changeLayout
    }){
      const [open, setOpen] = useState(false);
      const panelRef = useRef(null);

      useEffect(()=>{
        const onDocClick = (e)=>{
          if (!open) return;
          if (panelRef.current && !panelRef.current.contains(e.target)) {
            setOpen(false);
          }
        };
        document.addEventListener('click', onDocClick);
        return ()=>document.removeEventListener('click', onDocClick);
      },[open]);

      return (
        <div style={{position:'relative'}}>
          <button
            className="hamburger-btn"
            aria-label="Meny"
            aria-expanded={open}
            onClick={(e)=>{ e.stopPropagation(); setOpen(v=>!v); }}
          >
            <span className="hamburger-icon"><div/></span>
          </button>

          {open && (
            <>
              <div className="menu-overlay"/>
              <div className="menu-panel" ref={panelRef} onClick={(e)=>e.stopPropagation()}>
                <div className="menu-section">
                  <div className="menu-label">Tema & layout</div>
                  <ThemeDropdown/>
                  <LayoutDropdown layout={layoutMode} onChange={changeLayout}/>
                </div>

                <div className="menu-divider"></div>

                <div className="menu-section">
                  <button className="primary-btn header-cta" onClick={()=>{ setOpen(false); onNewPost(); }}>
                    <span style={{fontSize:18,lineHeight:1}}>➕</span>
                    <span>Nytt inlägg</span>
                  </button>
                  <div className="menu-row" style={{gap:10}}>
                    <button className="pill-btn" onClick={()=>{ setOpen(false); onShowTrash(); }} title="Visa papperskorg">🗑️ Papperskorg</button>
                    <button className="info-btn" onClick={()=>{ setOpen(false); onShowInfo(); }} title="Information">ℹ️</button>
                  </div>
                </div>

                <div className="menu-divider"></div>

                <div className="menu-section">
                  <div className="menu-label">Konto</div>
                  <div className="user-line" title={session.email}>
                    <div className="user-avatar">{(session.email||'?')[0].toUpperCase()}</div>
                    <div className="user-line-name">{fullNameFromEmail(session.email)}</div>
                  </div>
                  <button onClick={()=>{ setOpen(false); onLogout(); }} className="pill-btn logout-btn">Logga ut</button>
                </div>
              </div>
            </>
          )}
        </div>
      );
    }

    /* ===== Huvudvy ===== */
    function MainPage({ session, onLogout }) {
      const [posts,setPosts] = useState([]);
      const [categories,setCategories] = useState([]);
      const [loading,setLoading] = useState(true);

      const [showCreatePost,setShowCreatePost] = useState(false);
      const [editingPost,setEditingPost] = useState(null);
      const [showTrash,setShowTrash] = useState(false);
      const [showInfo, setShowInfo] = useState(false);
      const [confirmOpen,setConfirmOpen] = useState(false);
      const [postToDelete,setPostToDelete] = useState(null);
      
      const [selectedPost, setSelectedPost] = useState(null);
      const [showPostDetail, setShowPostDetail] = useState(false);

      const [searchQuery,setSearchQuery] = useState('');
      const [categoryFilter,setCategoryFilter] = useState('all');
      const [authorFilter,setAuthorFilter] = useState('');
      const [resultCount,setResultCount] = useState(0);

      /* Layoutläge (stacked/grid) – default grid */
      const [layoutMode, setLayoutMode] = useState(() => localStorage.getItem('siteLayout') || 'grid');
      const changeLayout = (mode) => {
        setLayoutMode(mode);
        localStorage.setItem('siteLayout', mode);
      };

      const loadPosts = async ()=>{
        setLoading(true);
        try {
          const res = await api.get('posts/search',{
            session: session.sessionToken,
            search: searchQuery,
            category: categoryFilter==='all' ? '' : categoryFilter,
            author: authorFilter
          });
          if (res.success) { setPosts(res.posts||[]); setResultCount(res.posts ? res.posts.length : 0); }
        } catch(err) { console.error(err); }
        finally { setLoading(false); }
      };
      
      const loadCategories = async ()=>{
        const res = await api.get('categories', { session: session.sessionToken });
        if (res.success) setCategories(res.categories||[]);
      };

      useEffect(()=>{ loadCategories(); },[]);
      useEffect(()=>{ loadPosts(); },[]); 
      useEffect(()=>{
        const t = setTimeout(()=>{ loadPosts(); }, 250);
        return ()=>clearTimeout(t);
      },[searchQuery,categoryFilter,authorFilter]);

      const clearFilters = ()=>{ setSearchQuery(''); setCategoryFilter('all'); setAuthorFilter(''); };
      const hasActiveFilters = searchQuery || categoryFilter!=='all' || authorFilter;

      const requestDelete = (post)=>{ setPostToDelete(post); setConfirmOpen(true); };
      const doDelete = async ()=>{
        if(!postToDelete) return; 
        setConfirmOpen(false);
        const res = await api.post('post/delete', { session: session.sessionToken, postId: postToDelete.post_id });
        if(!res.success) alert(res.error||'Kunde inte radera');
        await loadPosts(); 
        setPostToDelete(null);
      };

      const summaryOf = (p)=>{
        const s = (p.summary && String(p.summary).trim()) || '';
        if (s) return clamp(s, 140);
        return clamp(String(p.text||''), 140);
      };

      const handleLogout = async ()=>{
        try { await api.post('auth/logout',{ session: session.sessionToken }); } catch {}
        onLogout();
      };

      const openPost = (post, e) => {
        if (e.target.closest('.delete-btn') || e.target.closest('.edit-btn')) return;
        setSelectedPost(post);
        setShowPostDetail(true);
      };

      const handleEdit = (post) => {
        setEditingPost(post);
        setShowCreatePost(true);
      };

      const handleCloseModal = () => {
        setShowCreatePost(false);
        setEditingPost(null);
      };

      const handleSuccess = () => {
        loadPosts();
        setEditingPost(null);
      };

      return (
        <>
          <header className="glass-header">
            <a className="logo-area" href="#">
              <img src={CONFIG.LOGO_SRC} alt="Portal" className="logo-img"/>
              <span className="tagline">Plattformen för initiativ</span>
            </a>

            {/* HAMBURGER-MENY */}
            <HeaderMenu
              session={session}
              onNewPost={()=>setShowCreatePost(true)}
              onShowInfo={()=>setShowInfo(true)}
              onShowTrash={()=>setShowTrash(true)}
              onLogout={handleLogout}
              layoutMode={layoutMode}
              changeLayout={changeLayout}
            />
          </header>

          <main className="main-container">
            <SearchFilters
              searchQuery={searchQuery} setSearchQuery={setSearchQuery}
              categoryFilter={categoryFilter} setCategoryFilter={setCategoryFilter}
              authorFilter={authorFilter} setAuthorFilter={setAuthorFilter}
              categories={categories} onClear={clearFilters}
            />

            {hasActiveFilters && (
              <div className="results-count">{loading ? 'Söker…' : `${resultCount} inlägg funna`}</div>
            )}

            {loading ? (
              <Loader text="Laddar…"/>
            ) : posts.length===0 ? (
              <div className="loader-text">Inga inlägg ännu. Var först ut!</div>
            ) : (
              <div className={`posts-grid ${layoutMode === 'grid' ? 'grid' : 'stacked'}`}>
                {posts.map(post=>{
                  const isAuthor = String(post.author_email||'').toLowerCase() === String(session.email||'').toLowerCase();
                  return (
                    <article key={post.post_id} className="post-card" onClick={(e) => openPost(post, e)} style={{cursor:'pointer'}}>
                      <div className="post-header">
                        <div className="post-avatar">{(post.author_email||'?')[0].toUpperCase()}</div>
                        <div className="post-meta">
                          <h2 className="post-title">{post.title || '(utan rubrik)'}</h2>
                          <div className="post-author-info">
                            <div title={post.author_email}>{firstNameFromEmail(post.author_email)}</div>
                            <div>{new Date(post.created_at).toLocaleString('sv-SE')}</div>
                            {post.category && (
                              <div className="category-badge" style={{ backgroundColor: post.category.color || '#6B7280' }}>
                                {post.category.name}
                              </div>
                            )}
                          </div>
                        </div>
                        {isAuthor && (
                          <div style={{display:'flex',gap:4}}>
                            <button className="pill-btn edit-btn" title="Redigera" onClick={(e)=>{e.stopPropagation(); handleEdit(post);}}>✏️</button>
                            <button className="pill-btn delete-btn" title="Flytta till papperskorg" onClick={(e)=>{e.stopPropagation(); setPostToDelete(post); setConfirmOpen(true);}}>×</button>
                          </div>
                        )}
                      </div>

                      <div className="post-summary">{summaryOf(post)}</div>

                      <ProgressBar progress={post.progress || 'planeras'} />

                      <div className="post-actions" onClick={(e)=>e.stopPropagation()}>
                        <ReactionBar post={post} session={session}/>
                        <span className="comment-count">💬 {post.comments_count||0}</span>
                      </div>
                    </article>
                  );
                })}
              </div>
            )}
          </main>

          <CreateEditPostModal 
            isOpen={showCreatePost} 
            onClose={handleCloseModal} 
            session={session} 
            onSuccess={handleSuccess}
            editPost={editingPost}
          />
          <TrashModal isOpen={showTrash} onClose={()=>setShowTrash(false)} session={session} onChanged={()=>loadPosts()}/>
          <PostDetailModal 
            isOpen={showPostDetail} 
            onClose={()=>{setShowPostDetail(false); setSelectedPost(null);}} 
            post={selectedPost} 
            session={session}
            onEdit={handleEdit}
          />
          <InfoModal isOpen={showInfo} onClose={() => setShowInfo(false)} showEmailInfo={false} />

          <ConfirmModal
            isOpen={confirmOpen}
            title="Radera inlägg?"
            message="Vill du verkligen radera inlägget? Det flyttas till papperskorgen och kan återställas."
            confirmText="Ja, radera"
            cancelText="Avbryt"
            onConfirm={doDelete}
            onCancel={()=>{ setConfirmOpen(false); setPostToDelete(null); }}
          />
        </>
      );
    }

    /* ===== App ===== */
    function App(){
      const [session,setSession] = useState(null);
      const [booting,setBooting] = useState(true);
      
      useEffect(()=>{
        const savedTheme = localStorage.getItem('siteTheme') || 'blue';
        document.documentElement.setAttribute('data-theme', savedTheme);
        
        const saved = localStorage.getItem(CONFIG.STORAGE_KEY);
        if (saved) { 
          try { setSession(JSON.parse(saved)); } 
          catch { localStorage.removeItem(CONFIG.STORAGE_KEY); } 
        }
        setBooting(false);
      },[]);
      
      const onLogin = (sess)=>{ 
        setSession(sess); 
        localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(sess)); 
      };
      
      const onLogout = ()=>{ 
        setSession(null); 
        localStorage.removeItem(CONFIG.STORAGE_KEY); 
      };
      
      if (booting) return <Loader text="Startar…"/>;
      if (!session) return <LoginPage onLogin={onLogin}/>;
      return <MainPage session={session} onLogout={onLogout}/>;
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App/>);
  </script>
</body>
</html>
