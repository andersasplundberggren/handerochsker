">Alla kategorier</option>
                {categories.map(cat=>(
                  <option key={cat.category_id} value={cat.category_id}>{cat.name} ({cat.post_count||0})</option>
                ))}
              </select>
            </div>
            <div className="form-group">
              <label className="form-label">Författare</label>
              <input type="text" value={authorFilter} onChange={(e)=>setAuthorFilter(e.target.value)} className="search-input" placeholder="Filtrera på användare…"/>
            </div>
            <button onClick={onClear} className="clear-btn">Rensa</button>
          </div>
        </div>
      );
    }

    /* ===== SKAPA INLÄGG (UTAN NY KATEGORI-KNAPP) ===== */
    function CreatePostModal({ isOpen, onClose, session, onSuccess }) {
      const [title,setTitle] = useState('');
      const [summary,setSummary] = useState('');
      const [text,setText] = useState('');
      const [categoryId,setCategoryId] = useState('general');
      const [files,setFiles] = useState([]);
      const [categories,setCategories] = useState([]);
      const [loading,setLoading] = useState(false);
      const [error,setError] = useState('');

      useEffect(()=>{ if(isOpen) loadCategories(); },[isOpen]);

      const loadCategories = async () => {
        try {
          const res = await api.get('categories', { session: session.sessionToken });
          if (res.success) setCategories(res.categories || []);
          else setError(res.error || 'Kunde inte hämta kategorier');
        } catch(e){
          setError('Kunde inte hämta kategorier');
        }
      };

      const readFileAsBase64 = (file) => new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onload = ()=>resolve(String(reader.result).split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!summary.trim()) { setError('Sammanfattning krävs (max 140 tecken)'); return; }
        setLoading(true); setError('');
        try {
          const uploads = await Promise.all((files||[]).map(async f=>{
            const base64 = await readFileAsBase64(f);
            return api.post('file/upload',{ session: session.sessionToken, filename: f.name, mimeType: f.type, dataBase64: base64 });
          }));
          const fileIds = uploads.map(up => {
            if (!up.success) throw new Error(up.error || 'Uppladdning misslyckades');
            return up.fileId;
          });

          const result = await api.post('post/create',{
            session: session.sessionToken,
            title, summary, text, categoryId,
            imageFileIds: fileIds.join(',')
          });
          if (!result.success) throw new Error(result.error || 'Kunde inte skapa inlägg');

          setTitle(''); setSummary(''); setText(''); setCategoryId('general'); setFiles([]);
          onSuccess && onSuccess(); onClose();
        } catch (err) { setError(err.message); } finally { setLoading(false); }
      };

      const left = 140 - (summary?.length||0);

      return (
        <Modal isOpen={isOpen} onClose={onClose} title="Nytt inlägg">
          {error && <div className="error-message">{error}</div>}
          <form onSubmit={handleSubmit}>
            <div className="form-group">
              <label className="form-label">Rubrik</label>
              <input type="text" className="form-input" placeholder="Ange en beskrivande rubrik…" value={title} onChange={(e)=>setTitle(e.target.value)} required/>
            </div>

            <div className="form-group" style={{marginTop:16}}>
              <label className="form-label">Kategori</label>
              <select value={categoryId} onChange={(e)=>setCategoryId(e.target.value)} className="filter-select">
                {categories.map(cat => <option key={cat.category_id} value={cat.category_id}>{cat.name}</option>)}
              </select>
            </div>

            <div className="form-group" style={{marginTop:16}}>
              <label className="form-label">Sammanfattning (max 140 tecken)</label>
              <input type="text" className="form-input" value={summary} onChange={(e)=>setSummary(clamp(e.target.value, 140))} placeholder="Kort teaser till startsidan…" required />
              <div className="charline"><span>Förhandsvisas på startsidan</span><span>{left} tecken kvar</span></div>
            </div>

            <div className="form-group" style={{marginTop:16}}>
              <label className="form-label">Huvudtext</label>
              <textarea className="form-input" value={text} onChange={(e)=>setText(e.target.value)} placeholder="Beskriv idén eller lösningen…" required />
            </div>

            <div className="form-group" style={{marginTop:16}}>
              <label className="form-label">Bilder (valfritt)</label>
              <input type="file" accept="image/*" multiple onChange={(e)=>setFiles(Array.from(e.target.files||[]))} className="file-input"/>
              {files.length>0 && <div className="small-muted">{files.length} fil(er) valda</div>}
            </div>

            <div style={{display:'flex',justifyContent:'flex-end',gap:12,marginTop:20}}>
              <button type="button" onClick={onClose} className="ghost-btn">Avbryt</button>
              <button type="submit" disabled={loading} className="primary-btn">{loading?'Publicerar…':'Publicera'}</button>
            </div>
          </form>
        </Modal>
      );
    }

    /* ===== REAKTIONER ===== */
    function ReactionBar({ post, session, onUpdate }) {
      const [count,setCount] = useState(0);
      const [hasLiked,setHasLiked] = useState(false);
      const [busy,setBusy] = useState(false);

      const load = useCallback(async ()=>{
        const res = await api.get('post/reactions',{ postId: post.post_id, session: session.sessionToken });
        if (res.success) {
          setCount((res.counts && res.counts.like) || 0);
          setHasLiked((res.reactions||[]).some(r => r.userEmail===session.email && r.type==='like'));
        }
      },[post.post_id,session.email,session.sessionToken]);

      useEffect(()=>{ load(); },[load]);

      const toggle = async ()=>{
        setBusy(true);
        try{
          if(hasLiked) await api.post('post/reaction/remove',{ session: session.sessionToken, postId: post.post_id });
          else await api.post('post/reaction/add',{ session: session.sessionToken, postId: post.post_id, type:'like' });
          await load(); onUpdate && onUpdate();
        } finally { setBusy(false); }
      };

      return (
        <button onClick={toggle} disabled={busy} className={`action-btn ${hasLiked?'liked':''}`}>
          {hasLiked?'❤️':'♡'} {count}
        </button>
      );
    }

    /* ===== POST DETAIL MODAL MED KOMMENTARER ===== */
    function PostDetailModal({ isOpen, onClose, post, session }) {
      const [comments, setComments] = useState([]);
      const [commentText, setCommentText] = useState('');
      const [loadingComments, setLoadingComments] = useState(false);
      const [submitting, setSubmitting] = useState(false);

      useEffect(() => {
        if (isOpen && post) {
          loadComments();
        }
      }, [isOpen, post]);

      const loadComments = async () => {
        if (!post) return;
        setLoadingComments(true);
        try {
          const res = await api.get('post/comments', { 
            postId: post.post_id, 
            session: session.sessionToken 
          });
          if (res.success) {
            setComments(res.comments || []);
          }
        } catch (err) {
          console.error('Kunde inte ladda kommentarer:', err);
        } finally {
          setLoadingComments(false);
        }
      };

      const submitComment = async (e) => {
        e.preventDefault();
        if (!commentText.trim()) return;
        
        setSubmitting(true);
        try {
          const res = await api.post('post/comment/add', {
            session: session.sessionToken,
            postId: post.post_id,
            text: commentText
          });
          
          if (res.success) {
            setCommentText('');
            await loadComments();
          } else {
            alert('Kunde inte skicka kommentar: ' + (res.error || 'Okänt fel'));
          }
        } catch (err) {
          alert('Fel vid kommentering: ' + err.message);
        } finally {
          setSubmitting(false);
        }
      };

      if (!post) return null;

      return (
        <Modal isOpen={isOpen} onClose={onClose} title={post.title || '(utan rubrik)'}>
          <div className="post-detail-meta">
            <div className="post-avatar" style={{width:48,height:48,fontSize:18}}>
              {(post.author_email||'?')[0].toUpperCase()}
            </div>
            <div style={{flex:1}}>
              <div style={{fontWeight:600,marginBottom:4}}>
                {firstNameFromEmail(post.author_email)}
              </div>
              <div style={{fontSize:13,color:'var(--text-secondary)'}}>
                {new Date(post.created_at).toLocaleString('sv-SE')}
              </div>
            </div>
            {post.category && (
              <div className="category-badge" style={{ backgroundColor: post.category.color || '#6B7280' }}>
                {post.category.name}
              </div>
            )}
          </div>

          {post.summary && (
            <div style={{
              background: 'linear-gradient(135deg, #E8ECFF, #F0F4FF)',
              padding: 16,
              borderRadius: 12,
              marginBottom: 16,
              fontWeight: 500,
              color: '#374151'
            }}>
              {post.summary}
            </div>
          )}

          <div className="post-detail-content">
            {post.text}
          </div>

          {post.images && post.images.length > 0 && (
            <div className="post-detail-images">
              {post.images.map((img, idx) => (
                <img 
                  key={idx}
                  src={img.thumbnailUrl} 
                  alt={`Bild ${idx+1}`}
                  className="post-detail-image"
                  onClick={() => window.open(img.fullUrl, '_blank')}
                />
              ))}
            </div>
          )}

          <div style={{marginTop:24,paddingTop:16,borderTop:'1px solid #e5e7eb'}}>
            <ReactionBar post={post} session={session}/>
          </div>

          {/* KOMMENTARSSEKTION */}
          <div style={{marginTop:24,paddingTop:20,borderTop:'1px solid #e5e7eb'}}>
            <h3 style={{fontSize:16,fontWeight:600,marginBottom:16,display:'flex',alignItems:'center',gap:8}}>
              💬 Kommentarer
              <span style={{fontSize:14,fontWeight:400,color:'var(--text-secondary)'}}>
                ({comments.length})
              </span>
            </h3>

            {/* Kommentarslista */}
            {loadingComments ? (
              <div style={{textAlign:'center',padding:20,color:'var(--text-secondary)'}}>
                Laddar kommentarer...
              </div>
            ) : comments.length === 0 ? (
              <div style={{textAlign:'center',padding:20,color:'var(--text-secondary)',fontSize:14}}>
                Inga kommentarer ännu. Var först att kommentera!
              </div>
            ) : (
              <div style={{marginBottom:16}}>
                {comments.map(comment => (
                  <div key={comment.comment_id} style={{
                    background: 'rgba(249,250,251,0.8)',
                    border: '1px solid #e5e7eb',
                    borderRadius: 12,
                    padding: 12,
                    marginBottom: 10
                  }}>
                    <div style={{
                      display:'flex',
                      gap:8,
                      alignItems:'center',
                      marginBottom:6,
                      fontSize:12,
                      color:'var(--text-secondary)'
                    }}>
                      <div style={{
                        width:24,
                        height:24,
                        borderRadius:'50%',
                        background:'#e5e7eb',
                        display:'grid',
                        placeItems:'center',
                        fontSize:11,
                        fontWeight:700,
                        color:'#111827'
                      }}>
                        {(comment.user_email||'?')[0].toUpperCase()}
                      </div>
                      <span style={{fontWeight:600,color:'#374151'}}>
                        {firstNameFromEmail(comment.user_email)}
                      </span>
                      <span>•</span>
                      <span>{new Date(comment.created_at).toLocaleString('sv-SE')}</span>
                    </div>
                    <div style={{
                      paddingLeft:32,
                      color:'#374151',
                      lineHeight:1.5,
                      whiteSpace:'pre-wrap'
                    }}>
                      {comment.text}
                    </div>
                  </div>
                ))}
              </div>
            )}

            {/* Kommentarsformulär */}
            <form onSubmit={submitComment} style={{display:'flex',gap:8,marginTop:12}}>
              <input
                type="text"
                value={commentText}
                onChange={(e) => setCommentText(e.target.value)}
                placeholder="Skriv en kommentar..."
                disabled={submitting}
                style={{
                  flex:1,
                  padding:'10px 14px',
                  border:'1px solid rgba(0,0,0,.1)',
                  borderRadius:10,
                  fontSize:14,
                  background:'rgba(255,255,255,.9)',
                  transition:'.2s'
                }}
                onFocus={(e) => {
                  e.target.style.borderColor = 'var(--accent-blue)';
                  e.target.style.boxShadow = '0 0 0 3px rgba(88,99,199,.1)';
                }}
                onBlur={(e) => {
                  e.target.style.borderColor = 'rgba(0,0,0,.1)';
                  e.target.style.boxShadow = 'none';
                }}
              />
              <button
                type="submit"
                disabled={!commentText.trim() || submitting}
                style={{
                  border:'none',
                  padding:'10px 16px',
                  borderRadius:10,
                  background: commentText.trim() && !submitting ? 'var(--accent-blue)' : '#d1d5db',
                  color:'#fff',
                  fontWeight:700,
                  cursor: commentText.trim() && !submitting ? 'pointer' : 'not-allowed',
                  fontSize:14,
                  transition:'.2s'
                }}
              >
                {submitting ? 'Skickar...' : 'Skicka'}
              </button>
            </form>
          </div>
        </Modal>
      );
    }

    /* ===== PAPPERSKORG ===== */
    function TrashModal({ isOpen, onClose, session, onChanged }) {
      const [loading,setLoading] = useState(true);
      const [items,setItems] = useState([]);
      const [error,setError] = useState('');
      
      const loadTrash = async ()=>{
        setLoading(true); setError('');
        try{
          const res = await api.get('posts/trash', { session: session.sessionToken });
          if(!res.success) throw new Error(res.error||'Kunde inte hämta papperskorg');
          setItems(res.posts||[]);
        }catch(err){ setError(err.message); } finally { setLoading(false); }
      };
      
      useEffect(()=>{ if(isOpen) loadTrash(); },[isOpen]);

      const restore = async (postId)=>{
        try{ 
          const res = await api.post('post/restore',{ session: session.sessionToken, postId });
          if(!res.success) throw new Error(res.error||'Kunde inte återställa');
          await loadTrash(); onChanged && onChanged();
        }catch(err){ alert(err.message); }
      };
      
      const purge = async (postId)=>{
        if(!confirm('Radera permanent? Detta går inte att ångra.')) return;
        try{ 
          const res = await api.post('post/purge',{ session: session.sessionToken, postId });
          if(!res.success) throw new Error(res.error||'Kunde inte radera permanent');
          await loadTrash(); onChanged && onChanged();
        }catch(err){ alert(err.message); }
      };

      return (
        <Modal isOpen={isOpen} onClose={onClose} title="Papperskorg">
          {error && <div className="error-message">{error}</div>}
          {loading ? <Loader text="Hämtar papperskorg…"/> :
           items.length===0 ? <div className="loader-text">Papperskorgen är tom.</div> :
           <div className="trash-list">
            {items.map(p=>(
              <div key={p.post_id} className="trash-item">
                <div>
                  <div><strong>{p.title || '(utan rubrik)'}</strong></div>
                  <div className="small-muted">Av {firstNameFromEmail(p.author_email)} • {new Date(p.deleted_at||p.created_at).toLocaleString('sv-SE')}</div>
                </div>
                <button className="pill-btn" onClick={()=>restore(p.post_id)}>Återställ</button>
                <button className="pill-btn delete-btn" onClick={()=>purge(p.post_id)}>Radera permanent</button>
              </div>
            ))}
           </div>}
        </Modal>
      );
    }

    /* ===== HUVUDVY ===== */
    function MainPage({ session, onLogout }) {
      const [posts,setPosts] = useState([]);
      const [categories,setCategories] = useState([]);
      const [loading,setLoading] = useState(true);

      const [showCreatePost,setShowCreatePost] = useState(false);
      const [showTrash,setShowTrash] = useState(false);
      const [showInfo, setShowInfo] = useState(false);
      const [confirmOpen,setConfirmOpen] = useState(false);
      const [postToDelete,setPostToDelete] = useState(null);
      
      const [selectedPost, setSelectedPost] = useState(null);
      const [showPostDetail, setShowPostDetail] = useState(false);

      const [searchQuery,setSearchQuery] = useState('');
      const [categoryFilter,setCategoryFilter] = useState('all');
      const [authorFilter,setAuthorFilter] = useState('');
      const [resultCount,setResultCount] = useState(0);

      const loadPosts = async ()=>{
        setLoading(true);
        try {
          const res = await api.get('posts/search',{
            session: session.sessionToken,
            search: searchQuery,
            category: categoryFilter==='all' ? '' : categoryFilter,
            author: authorFilter
          });
          if (res.success) {
            setPosts(res.posts||[]);
            setResultCount(res.posts ? res.posts.length : 0);
          }
        } finally { setLoading(false); }
      };
      
      const loadCategories = async ()=>{
        const res = await api.get('categories', { session: session.sessionToken });
        if (res.success) setCategories(res.categories||[]);
      };

      useEffect(()=>{ loadCategories(); },[]);
      useEffect(()=>{
        const t = setTimeout(()=>{ loadPosts(); }, 250);
        return ()=>clearTimeout(t);
      },[searchQuery,categoryFilter,authorFilter]);

      const clearFilters = ()=>{ setSearchQuery(''); setCategoryFilter('all'); setAuthorFilter(''); };
      const hasActiveFilters = searchQuery || categoryFilter!=='all' || authorFilter;

      const requestDelete = (post)=>{ setPostToDelete(post); setConfirmOpen(true); };
      const doDelete = async ()=>{
        if(!postToDelete) return; 
        setConfirmOpen(false);
        const res = await api.post('post/delete', { session: session.sessionToken, postId: postToDelete.post_id });
        if(!res.success) alert(res.error||'Kunde inte radera');
        await loadPosts(); 
        setPostToDelete(null);
      };

      const summaryOf = (p)=>{
        const s = (p.summary && String(p.summary).trim()) || '';
        if (s) return clamp(s, 140);
        return clamp(String(p.text||''), 140);
      };

      const handleLogout = async ()=>{
        try { await api.post('auth/logout',{ session: session.sessionToken }); } catch {}
        onLogout();
      };

      const openPost = (post, e) => {
        if (e.target.closest('.delete-btn')) return;
        setSelectedPost(post);
        setShowPostDetail(true);
      };

      return (
        <>
          <header className="glass-header">
            <a className="logo-area" href="#">
              <img src="./hander_och_sker.png" alt="Karlskoga Portal" className="logo-img"/>
              <span className="tagline">kommunikationsplatsen</span>
            </a>
            <div className="user-info">
              <button 
                className="info-btn" 
                onClick={()=>setShowInfo(true)} 
                title="Information om plattformen"
              >
                ℹ️
              </button>
              <button className="pill-btn" onClick={()=>setShowTrash(true)} title="Visa papperskorg">🗑️ Papperskorg</button>
              <span className="user-name" title={session.email}>{session.displayName || firstNameFromEmail(session.email)}</span>
              <button onClick={handleLogout} className="pill-btn logout-btn">Logga ut</button>
            </div>
          </header>

          <main className="main-container">
            <SearchFilters
              searchQuery={searchQuery} setSearchQuery={setSearchQuery}
              categoryFilter={categoryFilter} setCategoryFilter={setCategoryFilter}
              authorFilter={authorFilter} setAuthorFilter={setAuthorFilter}
              categories={categories} onClear={clearFilters}
            />

            {hasActiveFilters && (
              <div className="results-count">{loading ? 'Söker…' : `${resultCount} inlägg funna`}</div>
            )}

            {!hasActiveFilters && (
              <div className="create-post-card" onClick={()=>setShowCreatePost(true)}>
                <div className="create-post-prompt">💡 Klicka för att skapa ett inlägg – vad har du på gång {session.displayName || firstNameFromEmail(session.email)}?</div>
              </div>
            )}

            {loading ? (
              <FunLoader/>
            ) : posts.length===0 ? (
              <div className="loader-text">{hasActiveFilters ? 'Inga inlägg matchar dina sökkriterier.' : 'Inga inlägg ännu. Var först ut!'}</div>
            ) : (
              <div className="posts-grid">
                {posts.map(post=>{
                  const isAuthor = String(post.author_email||'').toLowerCase() === String(session.email||'').toLowerCase();
                  return (
                    <article 
                      key={post.post_id} 
                      className="post-card"
                      onClick={(e) => openPost(post, e)}
                      style={{cursor: 'pointer'}}
                    >
                      <div className="post-header">
                        <div className="post-avatar">{(post.author_email||'?')[0].toUpperCase()}</div>
                        <div className="post-meta">
                          <h2 className="post-title">{post.title || '(utan rubrik)'}</h2>
                          <div className="post-author-info">
                            <div title={post.author_email}>{firstNameFromEmail(post.author_email)}</div>
                            <div>{new Date(post.created_at).toLocaleString('sv-SE')}</div>
                            {post.category && (
                              <div className="category-badge" style={{ backgroundColor: post.category.color || '#6B7280' }}>
                                {post.category.name}
                              </div>
                            )}
                          </div>
                        </div>
                        {isAuthor && (
                          <button 
                            className="pill-btn delete-btn" 
                            title="Flytta till papperskorg" 
                            onClick={(e)=>{e.stopPropagation(); requestDelete(post);}}
                          >×</button>
                        )}
                      </div>

                      <div className="post-summary">{summaryOf(post)}</div>

                      <div className="post-actions" onClick={(e)=>e.stopPropagation()}>
                        <ReactionBar post={post} session={session}/>
                        <span className="comment-count">💬 {post.comments_count||0}</span>
                      </div>
                    </article>
                  );
                })}
              </div>
            )}
          </main>

          <CreatePostModal isOpen={showCreatePost} onClose={()=>setShowCreatePost(false)} session={session} onSuccess={()=>loadPosts()}/>
          <TrashModal isOpen={showTrash} onClose={()=>setShowTrash(false)} session={session} onChanged={()=>loadPosts()}/>
          <PostDetailModal 
            isOpen={showPostDetail} 
            onClose={()=>{setShowPostDetail(false); setSelectedPost(null);}} 
            post={selectedPost} 
            session={session}
          />
          <InfoModal isOpen={showInfo} onClose={() => setShowInfo(false)} showEmailInfo={false} />
          <ConfirmModal
            isOpen={confirmOpen}
            title="Radera inlägg?"
            message="Vill du verkligen radera inlägget? Det flyttas till papperskorgen och kan återställas."
            confirmText="Ja, radera"
            cancelText="Avbryt"
            onConfirm={doDelete}
            onCancel={()=>{ setConfirmOpen(false); setPostToDelete(null); }}
          />
        </>
      );
    }

    /* ===== APP ===== */
    function App(){
      const [session,setSession] = useState(null);
      const [booting,setBooting] = useState(true);
      
      useEffect(()=>{
        const saved = localStorage.getItem('karlskoga_session');
        if (saved) { 
          try { 
            setSession(JSON.parse(saved)); 
          } catch { 
            localStorage.removeItem('karlskoga_session'); 
          } 
        }
        setBooting(false);
      },[]);
      
      const onLogin = (sess)=>{ 
        setSession(sess); 
        localStorage.setItem('karlskoga_session', JSON.stringify(sess)); 
      };
      
      const onLogout = ()=>{ 
        setSession(null); 
        localStorage.removeItem('karlskoga_session'); 
      };
      
      if (booting) return <Loader text="Startar…"/>;
      if (!session) return <LoginPage onLogin={onLogin}/>;
      return <MainPage session={session} onLogout={onLogout}/>;
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App/>);
  </script>
</body>
</html>
