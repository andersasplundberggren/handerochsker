<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>H√§nder & sker ‚Äì en plats f√∂r initiativ</title>
  <meta name="theme-color" content="#1877F2"/>

  <!-- React + Babel UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}

    :root{
      --fb-primary:#1877F2;
      --fb-hover:#166FE5;
      --fb-bg:#F0F2F5;
      --fb-card:#FFFFFF;
      --fb-border:#E4E6EB;
      --fb-text-primary:#050505;
      --fb-text-secondary:#65676B;
      --fb-text-tertiary:#8A8D91;
      --danger:#DC2626;
      --success:#10B981;
      --warning:#F59E0B;
      
      --shadow-card:0 1px 2px rgba(0,0,0,.1);
      --shadow-hover:0 2px 4px rgba(0,0,0,.1);
    }

    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      background:var(--fb-bg);
      min-height:100vh;
      color:var(--fb-text-primary);
      -webkit-font-smoothing:antialiased;
      overflow-x:hidden;
      margin:0;
    }

    /* ===== Facebook-style Header ===== */
    .fb-header{
      position:sticky;
      top:0;
      background:var(--fb-card);
      border-bottom:1px solid var(--fb-border);
      padding:8px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      z-index:1000;
      box-shadow:var(--shadow-card);
    }
    
    .fb-header-left{
      display:flex;
      align-items:center;
      gap:16px;
      flex:1;
    }
    
    .logo-area{
      display:flex;
      align-items:center;
      gap:12px;
      text-decoration:none;
    }
    
    .logo-img{
      height:40px;
      transition:.2s;
    }
    
    .fb-search{
      background:var(--fb-bg);
      border:none;
      border-radius:50px;
      padding:10px 16px;
      width:240px;
      font-size:15px;
      transition:.2s;
    }
    
    .fb-search:focus{
      outline:none;
      width:280px;
    }

    .fb-header-right{
      display:flex;
      align-items:center;
      gap:8px;
    }

    .fb-icon-btn{
      background:var(--fb-bg);
      border:none;
      border-radius:50%;
      width:40px;
      height:40px;
      display:grid;
      place-items:center;
      cursor:pointer;
      transition:.2s;
      font-size:18px;
    }
    
    .fb-icon-btn:hover{
      background:#E4E6EB;
    }

    .user-menu{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 8px;
      border-radius:20px;
      cursor:pointer;
      transition:.2s;
    }
    
    .user-menu:hover{
      background:var(--fb-bg);
    }

    .user-avatar{
      width:32px;
      height:32px;
      border-radius:50%;
      background:var(--fb-primary);
      color:white;
      display:grid;
      place-items:center;
      font-weight:600;
      font-size:14px;
    }

    .user-name-header{
      font-size:15px;
      font-weight:600;
      color:var(--fb-text-primary);
    }

    /* ===== Layout ===== */
    .fb-layout{
      display:flex;
      max-width:1680px;
      margin:0 auto;
      padding-top:16px;
    }

    /* ===== Sidebar ===== */
    .fb-sidebar{
      width:360px;
      padding:0 8px 24px 16px;
      position:sticky;
      top:72px;
      height:calc(100vh - 72px);
      overflow-y:auto;
      flex-shrink:0;
    }

    .fb-sidebar::-webkit-scrollbar{width:8px}
    .fb-sidebar::-webkit-scrollbar-thumb{background:#BCC0C4;border-radius:4px}

    .sidebar-section{
      margin-bottom:16px;
    }

    .sidebar-title{
      font-size:17px;
      font-weight:600;
      color:var(--fb-text-secondary);
      padding:8px;
      margin-bottom:4px;
    }

    .sidebar-item{
      display:flex;
      align-items:center;
      gap:12px;
      padding:8px;
      border-radius:8px;
      cursor:pointer;
      transition:.2s;
      text-decoration:none;
      color:var(--fb-text-primary);
    }

    .sidebar-item:hover{
      background:var(--fb-bg);
    }

    .sidebar-item.active{
      background:var(--fb-bg);
      font-weight:600;
    }

    .category-icon{
      width:36px;
      height:36px;
      border-radius:8px;
      display:grid;
      place-items:center;
      font-size:18px;
      flex-shrink:0;
    }

    .category-name{
      font-size:15px;
      flex:1;
    }

    .category-count{
      font-size:13px;
      color:var(--fb-text-tertiary);
      background:var(--fb-bg);
      padding:2px 8px;
      border-radius:12px;
    }

    /* ===== Main Feed ===== */
    .fb-feed{
      flex:1;
      max-width:680px;
      padding:0 32px;
      margin:0 auto;
    }

    /* Create post box */
    .create-box{
      background:var(--fb-card);
      border-radius:8px;
      padding:12px 16px;
      box-shadow:var(--shadow-card);
      margin-bottom:16px;
    }

    .create-box-top{
      display:flex;
      gap:12px;
      align-items:center;
      padding-bottom:12px;
      border-bottom:1px solid var(--fb-border);
    }

    .create-input{
      flex:1;
      background:var(--fb-bg);
      border:none;
      border-radius:50px;
      padding:10px 16px;
      cursor:pointer;
      font-size:15px;
      color:var(--fb-text-tertiary);
    }

    .create-input:hover{
      background:#E4E6EB;
    }

    /* Post card */
    .post-card{
      background:var(--fb-card);
      border-radius:8px;
      box-shadow:var(--shadow-card);
      margin-bottom:16px;
      cursor:pointer;
      transition:.2s;
    }

    .post-card:hover{
      box-shadow:var(--shadow-hover);
    }

    .post-card-header{
      padding:12px 16px;
      display:flex;
      gap:12px;
      align-items:center;
    }

    .post-avatar{
      width:40px;
      height:40px;
      border-radius:50%;
      background:var(--fb-primary);
      color:white;
      display:grid;
      place-items:center;
      font-weight:600;
      flex-shrink:0;
    }

    .post-info{
      flex:1;
    }

    .post-author-row{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .post-author-name{
      font-size:15px;
      font-weight:600;
      color:var(--fb-text-primary);
    }

    .post-category-badge{
      font-size:12px;
      font-weight:600;
      color:white;
      padding:2px 8px;
      border-radius:4px;
    }

    .post-timestamp{
      font-size:13px;
      color:var(--fb-text-secondary);
      display:flex;
      align-items:center;
      gap:4px;
    }

    .post-title{
      font-size:18px;
      font-weight:600;
      color:var(--fb-text-primary);
      margin:8px 16px 4px;
    }

    .post-content{
      padding:0 16px 12px;
      font-size:15px;
      line-height:1.5;
      color:var(--fb-text-primary);
    }

    .post-progress{
      padding:0 16px 12px;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .progress-dot{
      width:8px;
      height:8px;
      border-radius:50%;
    }

    .progress-text{
      font-size:13px;
      font-weight:600;
    }

    .post-actions{
      border-top:1px solid var(--fb-border);
      padding:4px 16px;
      display:flex;
      justify-content:space-around;
    }

    .post-action-btn{
      flex:1;
      background:none;
      border:none;
      padding:8px;
      border-radius:4px;
      cursor:pointer;
      font-size:15px;
      font-weight:600;
      color:var(--fb-text-secondary);
      transition:.2s;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
    }

    .post-action-btn:hover{
      background:var(--fb-bg);
    }

    .post-action-btn.liked{
      color:var(--fb-primary);
    }

    /* Right sidebar */
    .fb-right-sidebar{
      width:280px;
      padding:0 16px 24px 8px;
      position:sticky;
      top:72px;
      height:calc(100vh - 72px);
      overflow-y:auto;
      flex-shrink:0;
    }

    .sponsored-label{
      font-size:13px;
      color:var(--fb-text-tertiary);
      font-weight:600;
      padding:8px;
      margin-bottom:8px;
    }

    /* Filter panel */
    .filter-panel{
      background:var(--fb-card);
      border-radius:8px;
      padding:16px;
      box-shadow:var(--shadow-card);
      margin-bottom:16px;
    }

    .filter-title{
      font-size:17px;
      font-weight:600;
      margin-bottom:12px;
    }

    .filter-group{
      margin-bottom:16px;
    }

    .filter-label{
      font-size:13px;
      font-weight:600;
      color:var(--fb-text-secondary);
      display:block;
      margin-bottom:6px;
    }

    .filter-select,
    .filter-input{
      width:100%;
      padding:8px 12px;
      border:1px solid var(--fb-border);
      border-radius:6px;
      font-size:15px;
      background:var(--fb-card);
      transition:.2s;
    }

    .filter-select:focus,
    .filter-input:focus{
      outline:none;
      border-color:var(--fb-primary);
    }

    .filter-clear-btn{
      width:100%;
      background:var(--fb-bg);
      border:none;
      padding:8px;
      border-radius:6px;
      cursor:pointer;
      font-size:15px;
      font-weight:600;
      color:var(--fb-text-secondary);
      transition:.2s;
    }

    .filter-clear-btn:hover{
      background:#E4E6EB;
    }

    /* Buttons */
    .fb-btn{
      background:var(--fb-primary);
      color:white;
      border:none;
      padding:10px 24px;
      border-radius:6px;
      font-size:15px;
      font-weight:600;
      cursor:pointer;
      transition:.2s;
    }

    .fb-btn:hover{
      background:var(--fb-hover);
    }

    .fb-btn:disabled{
      opacity:.5;
      cursor:not-allowed;
    }

    .fb-btn-secondary{
      background:var(--fb-bg);
      color:var(--fb-text-primary);
    }

    .fb-btn-secondary:hover{
      background:#E4E6EB;
    }

    /* Modals */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(255,255,255,.8);
      backdrop-filter:blur(4px);
      z-index:2000;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      animation:fadeIn .2s;
    }

    @keyframes fadeIn{from{opacity:0}to{opacity:1}}

    .modal-content{
      background:var(--fb-card);
      border-radius:8px;
      box-shadow:0 12px 28px rgba(0,0,0,.15);
      max-width:700px;
      width:100%;
      max-height:90vh;
      overflow-y:auto;
      animation:slideUp .2s;
    }

    @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}

    .modal-header{
      padding:16px 20px;
      border-bottom:1px solid var(--fb-border);
      display:flex;
      align-items:center;
      justify-content:space-between;
    }

    .modal-title{
      font-size:20px;
      font-weight:600;
    }

    .modal-close{
      background:var(--fb-bg);
      border:none;
      width:36px;
      height:36px;
      border-radius:50%;
      cursor:pointer;
      font-size:24px;
      color:var(--fb-text-secondary);
      display:grid;
      place-items:center;
      transition:.2s;
    }

    .modal-close:hover{
      background:#E4E6EB;
    }

    .modal-body{
      padding:20px;
    }

    .form-group{
      margin-bottom:16px;
    }

    .form-label{
      display:block;
      font-size:15px;
      font-weight:600;
      margin-bottom:6px;
      color:var(--fb-text-primary);
    }

    .form-input{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--fb-border);
      border-radius:6px;
      font-size:15px;
      background:var(--fb-card);
      transition:.2s;
      font-family:inherit;
    }

    .form-input:focus{
      outline:none;
      border-color:var(--fb-primary);
    }

    textarea.form-input{
      min-height:120px;
      resize:vertical;
    }

    .modal-footer{
      padding:12px 20px;
      border-top:1px solid var(--fb-border);
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }

    /* Login page */
    .login-container{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:32px;
      background:var(--fb-bg);
    }

    .login-card{
      background:var(--fb-card);
      border-radius:8px;
      padding:40px;
      box-shadow:0 2px 4px rgba(0,0,0,.1),0 8px 16px rgba(0,0,0,.1);
      text-align:center;
      max-width:450px;
      width:100%;
    }

    .login-logo{
      height:80px;
      margin-bottom:16px;
    }

    .login-title{
      font-size:28px;
      font-weight:600;
      margin-bottom:8px;
    }

    .login-subtitle{
      font-size:15px;
      color:var(--fb-text-secondary);
      margin-bottom:24px;
    }

    .login-form{
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    .form-input.otp-input{
      text-align:center;
      font-size:24px;
      letter-spacing:4px;
      font-weight:600;
    }

    .success-message{
      background:#D4F4E7;
      color:#065F46;
      padding:12px;
      border-radius:6px;
      font-size:15px;
      margin-bottom:12px;
    }

    .error-message{
      background:#FEE2E2;
      color:var(--danger);
      padding:12px;
      border-radius:6px;
      font-size:15px;
      margin-bottom:12px;
    }

    .loader{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
      padding:40px;
    }

    .spinner{
      width:32px;
      height:32px;
      border-radius:50%;
      border:3px solid var(--fb-bg);
      border-top-color:var(--fb-primary);
      animation:spin .8s linear infinite;
    }

    @keyframes spin{to{transform:rotate(360deg)}}

    .loader-text{
      color:var(--fb-text-secondary);
      font-size:15px;
    }

    .results-count{
      text-align:center;
      color:var(--fb-text-secondary);
      font-size:15px;
      margin:16px 0;
      padding:12px;
      background:var(--fb-card);
      border-radius:8px;
    }

    /* Mobile responsive */
    @media (max-width:1024px){
      .fb-sidebar,
      .fb-right-sidebar{
        display:none;
      }
      
      .fb-feed{
        max-width:100%;
        padding:0 16px;
      }

      .fb-search{
        display:none;
      }
    }

    /* Edit/Delete button styles */
    .post-menu-btn{
      background:none;
      border:none;
      color:var(--fb-text-secondary);
      font-size:20px;
      cursor:pointer;
      padding:4px 8px;
      border-radius:4px;
      transition:.2s;
    }

    .post-menu-btn:hover{
      background:var(--fb-bg);
    }

    .delete-btn{
      color:var(--danger);
    }

    .edit-btn{
      color:var(--fb-primary);
    }

    /* File upload styling */
    .file-input{
      padding:8px;
      border:1px solid var(--fb-border);
      border-radius:6px;
      font-size:14px;
    }

    /* Trash modal */
    .trash-item{
      padding:12px;
      border:1px solid var(--fb-border);
      border-radius:6px;
      margin-bottom:8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      background:var(--fb-card);
    }

    .trash-item-info{
      flex:1;
    }

    .trash-item-title{
      font-weight:600;
      margin-bottom:4px;
    }

    .trash-item-meta{
      font-size:13px;
      color:var(--fb-text-secondary);
    }

    .trash-actions{
      display:flex;
      gap:8px;
    }

    .icon-btn{
      background:var(--fb-bg);
      border:none;
      padding:6px 12px;
      border-radius:4px;
      cursor:pointer;
      font-size:13px;
      transition:.2s;
    }

    .icon-btn:hover{
      background:#E4E6EB;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const {useState,useEffect,useRef} = React;

    const CONFIG = {
      API_BASE: 'https://hhvvvvevf7.execute-api.eu-north-1.amazonaws.com/prod',
      STORAGE_KEY: 'haenderSkerSession',
    };

    async function apiCall(endpoint, method='GET', body=null, email=null){
      const url = CONFIG.API_BASE + endpoint;
      const opts = {method, headers:{'Content-Type':'application/json'}};
      if (email) opts.headers['X-User-Email']=email;
      if (body) opts.body = JSON.stringify(body);
      const res = await fetch(url, opts);
      if (!res.ok) throw new Error(`API error: ${res.status}`);
      return res.json();
    }

    function firstNameFromEmail(email){
      if (!email) return '?';
      const local = email.split('@')[0];
      const name = local.split('.')[0];
      return name.charAt(0).toUpperCase()+name.slice(1);
    }

    function summaryOf(post){
      const text = post.description||'';
      if (text.length<=150) return text;
      return text.substring(0,147)+'...';
    }

    function Loader({text}){
      return (
        <div className="loader">
          <div className="spinner"></div>
          <div className="loader-text">{text}</div>
        </div>
      );
    }

    function ConfirmModal({isOpen,title,message,confirmText,cancelText,onConfirm,onCancel}){
      if (!isOpen) return null;
      return (
        <div className="modal-overlay" onClick={onCancel}>
          <div className="modal-content" onClick={(e)=>e.stopPropagation()} style={{maxWidth:'450px'}}>
            <div className="modal-header">
              <h2 className="modal-title">{title}</h2>
              <button className="modal-close" onClick={onCancel}>√ó</button>
            </div>
            <div className="modal-body">
              <p style={{fontSize:'15px',lineHeight:'1.5'}}>{message}</p>
            </div>
            <div className="modal-footer">
              <button className="fb-btn fb-btn-secondary" onClick={onCancel}>{cancelText}</button>
              <button className="fb-btn" onClick={onConfirm}>{confirmText}</button>
            </div>
          </div>
        </div>
      );
    }

    function InfoModal({isOpen,onClose,showEmailInfo}){
      if (!isOpen) return null;
      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal-content" onClick={(e)=>e.stopPropagation()}>
            <div className="modal-header">
              <h2 className="modal-title">Om plattformen</h2>
              <button className="modal-close" onClick={onClose}>√ó</button>
            </div>
            <div className="modal-body">
              <p style={{marginBottom:'16px',fontSize:'15px',lineHeight:'1.6'}}>
                V√§lkommen! H√§r kan du dela med dig av initiativ, projekt och id√©er. 
                Dela g√§rna vad du arbetar med och inspirera andra.
              </p>
              {showEmailInfo && (
                <p style={{fontSize:'15px',lineHeight:'1.6'}}>
                  En eng√•ngskod skickas till din e-post f√∂r s√§ker inloggning.
                </p>
              )}
            </div>
            <div className="modal-footer">
              <button className="fb-btn" onClick={onClose}>St√§ng</button>
            </div>
          </div>
        </div>
      );
    }

    function LoginPage({onLogin}){
      const [step,setStep] = useState('email');
      const [email,setEmail] = useState('');
      const [otp,setOtp] = useState('');
      const [error,setError] = useState('');
      const [success,setSuccess] = useState('');
      const [loading,setLoading] = useState(false);
      const [showInfo,setShowInfo] = useState(false);

      async function handleRequestOTP(e){
        e.preventDefault();
        if (!email.trim()){setError('Ange din e-postadress'); return;}
        setError(''); setSuccess(''); setLoading(true);
        try {
          await apiCall('/auth/request-otp','POST',{email});
          setSuccess('En inloggningskod har skickats till din e-post!');
          setStep('otp');
        } catch (err){
          setError('N√•got gick fel. F√∂rs√∂k igen.');
        } finally {
          setLoading(false);
        }
      }

      async function handleVerifyOTP(e){
        e.preventDefault();
        if (!otp.trim()){setError('Ange din kod'); return;}
        setError(''); setSuccess(''); setLoading(true);
        try {
          const data = await apiCall('/auth/verify-otp','POST',{email,otp});
          const sess = {email, displayName: data.display_name||null, token: data.token};
          setSuccess('Inloggad!');
          setTimeout(()=>onLogin(sess),500);
        } catch (err){
          setError('Felaktig kod. F√∂rs√∂k igen.');
        } finally {
          setLoading(false);
        }
      }

      return (
        <div className="login-container">
          <div className="login-card">
            <img src="https://byggahus.se/img/logo.svg" alt="Logo" className="login-logo"/>
            <h1 className="login-title">H√§nder & sker</h1>
            <p className="login-subtitle">Dela och uppt√§ck initiativ i v√•r community</p>

            {error && <div className="error-message">{error}</div>}
            {success && <div className="success-message">{success}</div>}

            {step==='email' && (
              <form className="login-form" onSubmit={handleRequestOTP}>
                <div className="form-group">
                  <input 
                    type="email" 
                    className="form-input" 
                    placeholder="E-postadress"
                    value={email} 
                    onChange={(e)=>setEmail(e.target.value)}
                    disabled={loading}
                  />
                </div>
                <button type="submit" className="fb-btn" disabled={loading}>
                  {loading ? 'Skickar...' : 'Forts√§tt'}
                </button>
                <button type="button" className="fb-btn fb-btn-secondary" onClick={()=>setShowInfo(true)}>
                  Information
                </button>
              </form>
            )}

            {step==='otp' && (
              <form className="login-form" onSubmit={handleVerifyOTP}>
                <div className="form-group">
                  <input 
                    type="text" 
                    className="form-input otp-input" 
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    value={otp} 
                    onChange={(e)=>setOtp(e.target.value)}
                    maxLength="6"
                    disabled={loading}
                  />
                </div>
                <button type="submit" className="fb-btn" disabled={loading}>
                  {loading ? 'Verifierar...' : 'Logga in'}
                </button>
                <button type="button" className="fb-btn fb-btn-secondary" onClick={()=>{setStep('email'); setOtp(''); setError(''); setSuccess('');}}>
                  Tillbaka
                </button>
              </form>
            )}
          </div>
          <InfoModal isOpen={showInfo} onClose={()=>setShowInfo(false)} showEmailInfo={true}/>
        </div>
      );
    }

    function ProgressIndicator({progress}){
      const configs = {
        planeras: {color:'#F59E0B', text:'Planeras'},
        pilot: {color:'#3B82F6', text:'Pilotl√§ge'},
        driftsatt: {color:'#10B981', text:'Driftsatt'}
      };
      const config = configs[progress] || configs.planeras;
      return (
        <div className="post-progress">
          <div className="progress-dot" style={{backgroundColor:config.color}}></div>
          <span className="progress-text" style={{color:config.color}}>{config.text}</span>
        </div>
      );
    }

    function ReactionBar({post, session}){
      const [liked, setLiked] = useState(false);
      const [count, setCount] = useState(post.likes_count||0);

      useEffect(()=>{
        if (!post.user_liked) return;
        setLiked(post.user_liked);
      },[post.user_liked]);

      async function toggleLike(e){
        e.stopPropagation();
        const newLiked = !liked;
        setLiked(newLiked);
        setCount(newLiked ? count+1 : count-1);
        try {
          await apiCall(`/posts/${post.post_id}/like`, 'POST', {liked:newLiked}, session.email);
        } catch (err){
          setLiked(!newLiked);
          setCount(newLiked ? count-1 : count+1);
        }
      }

      return (
        <button className={`post-action-btn ${liked?'liked':''}`} onClick={toggleLike}>
          {liked ? 'üëç' : 'üëç'} {count>0 && count}
        </button>
      );
    }

    function CreateEditPostModal({isOpen,onClose,session,onSuccess,editPost}){
      const [title,setTitle] = useState('');
      const [description,setDescription] = useState('');
      const [category,setCategory] = useState('');
      const [progress,setProgress] = useState('planeras');
      const [image,setImage] = useState(null);
      const [categories,setCategories] = useState([]);
      const [loading,setLoading] = useState(false);
      const [error,setError] = useState('');

      useEffect(()=>{
        if (isOpen) {
          if (editPost) {
            setTitle(editPost.title||'');
            setDescription(editPost.description||'');
            setCategory(editPost.category_id||'');
            setProgress(editPost.progress||'planeras');
          } else {
            setTitle(''); setDescription(''); setCategory(''); setProgress('planeras'); setImage(null);
          }
          setError('');
          loadCategories();
        }
      },[isOpen,editPost]);

      async function loadCategories(){
        try {
          const data = await apiCall('/categories');
          setCategories(data.categories||[]);
        } catch {}
      }

      async function handleSubmit(e){
        e.preventDefault();
        if (!title.trim()){setError('Rubrik kr√§vs'); return;}
        setLoading(true); setError('');
        try {
          const body = {title,description,category_id:category||null,progress};
          if (editPost){
            await apiCall(`/posts/${editPost.post_id}`,'PUT',body,session.email);
          } else {
            const created = await apiCall('/posts','POST',body,session.email);
            if (image){
              const fd = new FormData();
              fd.append('image',image);
              await fetch(`${CONFIG.API_BASE}/posts/${created.post_id}/image`,{
                method:'POST',
                headers:{'X-User-Email':session.email},
                body:fd
              });
            }
          }
          onSuccess();
          onClose();
        } catch (err){
          setError('N√•got gick fel');
        } finally {
          setLoading(false);
        }
      }

      if (!isOpen) return null;

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal-content" onClick={(e)=>e.stopPropagation()}>
            <div className="modal-header">
              <h2 className="modal-title">{editPost ? 'Redigera inl√§gg' : 'Skapa inl√§gg'}</h2>
              <button className="modal-close" onClick={onClose}>√ó</button>
            </div>
            <form onSubmit={handleSubmit}>
              <div className="modal-body">
                {error && <div className="error-message">{error}</div>}
                <div className="form-group">
                  <label className="form-label">Rubrik *</label>
                  <input 
                    type="text" 
                    className="form-input" 
                    value={title} 
                    onChange={(e)=>setTitle(e.target.value)}
                    disabled={loading}
                  />
                </div>
                <div className="form-group">
                  <label className="form-label">Beskrivning</label>
                  <textarea 
                    className="form-input" 
                    value={description} 
                    onChange={(e)=>setDescription(e.target.value)}
                    disabled={loading}
                  ></textarea>
                </div>
                <div className="form-group">
                  <label className="form-label">Kategori</label>
                  <select className="filter-select" value={category} onChange={(e)=>setCategory(e.target.value)} disabled={loading}>
                    <option value="">V√§lj kategori</option>
                    {categories.map(cat=><option key={cat.category_id} value={cat.category_id}>{cat.name}</option>)}
                  </select>
                </div>
                <div className="form-group">
                  <label className="form-label">Status</label>
                  <select className="filter-select" value={progress} onChange={(e)=>setProgress(e.target.value)} disabled={loading}>
                    <option value="planeras">Planeras</option>
                    <option value="pilot">Pilotl√§ge</option>
                    <option value="driftsatt">Driftsatt</option>
                  </select>
                </div>
                {!editPost && (
                  <div className="form-group">
                    <label className="form-label">Bild (valfritt)</label>
                    <input 
                      type="file" 
                      className="file-input" 
                      accept="image/*" 
                      onChange={(e)=>setImage(e.target.files[0])}
                      disabled={loading}
                    />
                  </div>
                )}
              </div>
              <div className="modal-footer">
                <button type="button" className="fb-btn fb-btn-secondary" onClick={onClose} disabled={loading}>Avbryt</button>
                <button type="submit" className="fb-btn" disabled={loading}>
                  {loading ? 'Sparar...' : (editPost ? 'Spara' : 'Publicera')}
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    function PostDetailModal({isOpen,onClose,post,session,onEdit}){
      const [comments,setComments] = useState([]);
      const [newComment,setNewComment] = useState('');
      const [loading,setLoading] = useState(false);

      useEffect(()=>{
        if (isOpen && post) loadComments();
      },[isOpen,post]);

      async function loadComments(){
        try {
          const data = await apiCall(`/posts/${post.post_id}/comments`);
          setComments(data.comments||[]);
        } catch {}
      }

      async function handleAddComment(e){
        e.preventDefault();
        if (!newComment.trim()) return;
        setLoading(true);
        try {
          await apiCall(`/posts/${post.post_id}/comments`,'POST',{text:newComment},session.email);
          setNewComment('');
          await loadComments();
        } catch {}
        setLoading(false);
      }

      if (!isOpen || !post) return null;

      const isAuthor = String(post.author_email||'').toLowerCase() === String(session.email||'').toLowerCase();

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal-content" onClick={(e)=>e.stopPropagation()}>
            <div className="modal-header">
              <h2 className="modal-title">{post.title}</h2>
              <button className="modal-close" onClick={onClose}>√ó</button>
            </div>
            <div className="modal-body">
              <div style={{display:'flex',alignItems:'center',gap:'12px',marginBottom:'16px'}}>
                <div className="user-avatar">{(post.author_email||'?')[0].toUpperCase()}</div>
                <div>
                  <div style={{fontWeight:'600'}}>{firstNameFromEmail(post.author_email)}</div>
                  <div style={{fontSize:'13px',color:'var(--fb-text-secondary)'}}>{new Date(post.created_at).toLocaleString('sv-SE')}</div>
                </div>
              </div>

              {post.category && (
                <div className="post-category-badge" style={{backgroundColor:post.category.color||'#6B7280',display:'inline-block',marginBottom:'12px'}}>
                  {post.category.name}
                </div>
              )}

              <ProgressIndicator progress={post.progress||'planeras'}/>

              <p style={{fontSize:'15px',lineHeight:'1.6',marginTop:'16px',whiteSpace:'pre-wrap'}}>{post.description}</p>

              {post.image_url && (
                <img src={post.image_url} alt={post.title} style={{width:'100%',borderRadius:'8px',marginTop:'16px'}}/>
              )}

              <div style={{marginTop:'24px',paddingTop:'16px',borderTop:'1px solid var(--fb-border)'}}>
                <h3 style={{fontSize:'17px',fontWeight:'600',marginBottom:'12px'}}>Kommentarer ({comments.length})</h3>
                {comments.length===0 ? (
                  <p style={{color:'var(--fb-text-secondary)',fontSize:'15px'}}>Inga kommentarer √§nnu. Var f√∂rst att kommentera!</p>
                ) : (
                  comments.map(c=>(
                    <div key={c.comment_id} style={{marginBottom:'12px',padding:'12px',background:'var(--fb-bg)',borderRadius:'8px'}}>
                      <div style={{fontWeight:'600',marginBottom:'4px'}}>{firstNameFromEmail(c.author_email)}</div>
                      <div style={{fontSize:'13px',color:'var(--fb-text-secondary)',marginBottom:'8px'}}>{new Date(c.created_at).toLocaleString('sv-SE')}</div>
                      <div style={{fontSize:'15px'}}>{c.text}</div>
                    </div>
                  ))
                )}
                <form onSubmit={handleAddComment} style={{marginTop:'16px',display:'flex',gap:'8px'}}>
                  <input 
                    type="text" 
                    className="form-input" 
                    placeholder="Skriv en kommentar..."
                    value={newComment}
                    onChange={(e)=>setNewComment(e.target.value)}
                    disabled={loading}
                    style={{flex:1}}
                  />
                  <button type="submit" className="fb-btn" disabled={loading}>Skicka</button>
                </form>
              </div>
            </div>
            {isAuthor && (
              <div className="modal-footer">
                <button className="fb-btn fb-btn-secondary edit-btn" onClick={()=>{onEdit(post); onClose();}}>‚úèÔ∏è Redigera</button>
              </div>
            )}
          </div>
        </div>
      );
    }

    function TrashModal({isOpen,onClose,session,onChanged}){
      const [items,setItems] = useState([]);
      const [loading,setLoading] = useState(false);

      useEffect(()=>{
        if (isOpen) loadTrash();
      },[isOpen]);

      async function loadTrash(){
        setLoading(true);
        try {
          const data = await apiCall('/trash',{}, session.email);
          setItems(data.posts||[]);
        } catch {}
        setLoading(false);
      }

      async function handleRestore(postId){
        try {
          await apiCall(`/trash/${postId}/restore`,'POST',{},session.email);
          await loadTrash();
          onChanged();
        } catch {}
      }

      async function handleDelete(postId){
        if (!confirm('Radera permanent?')) return;
        try {
          await apiCall(`/trash/${postId}`,'DELETE',null,session.email);
          await loadTrash();
        } catch {}
      }

      if (!isOpen) return null;

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal-content" onClick={(e)=>e.stopPropagation()}>
            <div className="modal-header">
              <h2 className="modal-title">üóëÔ∏è Papperskorg</h2>
              <button className="modal-close" onClick={onClose}>√ó</button>
            </div>
            <div className="modal-body">
              {loading ? (
                <Loader text="Laddar..."/>
              ) : items.length===0 ? (
                <p style={{color:'var(--fb-text-secondary)'}}>Papperskorgen √§r tom.</p>
              ) : (
                items.map(item=>(
                  <div key={item.post_id} className="trash-item">
                    <div className="trash-item-info">
                      <div className="trash-item-title">{item.title}</div>
                      <div className="trash-item-meta">Raderad: {new Date(item.deleted_at).toLocaleString('sv-SE')}</div>
                    </div>
                    <div className="trash-actions">
                      <button className="icon-btn" onClick={()=>handleRestore(item.post_id)}>‚Ü©Ô∏è √Öterst√§ll</button>
                      <button className="icon-btn delete-btn" onClick={()=>handleDelete(item.post_id)}>üóëÔ∏è Radera</button>
                    </div>
                  </div>
                ))
              )}
            </div>
            <div className="modal-footer">
              <button className="fb-btn" onClick={onClose}>St√§ng</button>
            </div>
          </div>
        </div>
      );
    }

    function MainPage({session,onLogout}){
      const [posts,setPosts] = useState([]);
      const [categories,setCategories] = useState([]);
      const [loading,setLoading] = useState(true);
      const [showCreatePost,setShowCreatePost] = useState(false);
      const [showTrash,setShowTrash] = useState(false);
      const [showInfo,setShowInfo] = useState(false);
      const [showPostDetail,setShowPostDetail] = useState(false);
      const [selectedPost,setSelectedPost] = useState(null);
      const [editingPost,setEditingPost] = useState(null);
      const [searchQuery,setSearchQuery] = useState('');
      const [categoryFilter,setCategoryFilter] = useState('');
      const [authorFilter,setAuthorFilter] = useState('');
      const [confirmOpen,setConfirmOpen] = useState(false);
      const [postToDelete,setPostToDelete] = useState(null);

      useEffect(()=>{
        loadPosts();
        loadCategories();
      },[searchQuery,categoryFilter,authorFilter]);

      async function loadPosts(){
        setLoading(true);
        try {
          let url = `/posts?email=${encodeURIComponent(session.email)}`;
          if (searchQuery) url+=`&search=${encodeURIComponent(searchQuery)}`;
          if (categoryFilter) url+=`&category=${encodeURIComponent(categoryFilter)}`;
          if (authorFilter) url+=`&author=${encodeURIComponent(authorFilter)}`;
          const data = await apiCall(url);
          setPosts(data.posts||[]);
        } catch {}
        setLoading(false);
      }

      async function loadCategories(){
        try {
          const data = await apiCall('/categories');
          setCategories(data.categories||[]);
        } catch {}
      }

      function handleLogout(){
        if (confirm('Vill du logga ut?')) onLogout();
      }

      function handleSuccess(){
        loadPosts();
        setEditingPost(null);
      }

      function handleEdit(post){
        setEditingPost(post);
        setShowCreatePost(true);
      }

      function handleCloseModal(){
        setShowCreatePost(false);
        setEditingPost(null);
      }

      function openPost(post,e){
        if (e.target.closest('button')) return;
        setSelectedPost(post);
        setShowPostDetail(true);
      }

      async function doDelete(){
        if (!postToDelete) return;
        try {
          await apiCall(`/posts/${postToDelete.post_id}`,'DELETE',null,session.email);
          await loadPosts();
        } catch {}
        setConfirmOpen(false);
        setPostToDelete(null);
      }

      function clearFilters(){
        setSearchQuery('');
        setCategoryFilter('');
        setAuthorFilter('');
      }

      const hasActiveFilters = searchQuery || categoryFilter || authorFilter;
      const resultCount = posts.length;

      const activeCategoryFilter = categoryFilter;

      return (
        <>
          <header className="fb-header">
            <div className="fb-header-left">
              <div className="logo-area">
                <img src="https://byggahus.se/img/logo.svg" alt="Logo" className="logo-img"/>
              </div>
              <input 
                type="text" 
                className="fb-search" 
                placeholder="S√∂k p√• plattformen..."
                value={searchQuery}
                onChange={(e)=>setSearchQuery(e.target.value)}
              />
            </div>
            <div className="fb-header-right">
              <button className="fb-icon-btn" onClick={()=>setShowInfo(true)} title="Information">‚ÑπÔ∏è</button>
              <button className="fb-icon-btn" onClick={()=>setShowTrash(true)} title="Papperskorg">üóëÔ∏è</button>
              <div className="user-menu" onClick={handleLogout} title="Logga ut">
                <div className="user-avatar">{(session.email||'?')[0].toUpperCase()}</div>
                <span className="user-name-header">{session.displayName || firstNameFromEmail(session.email)}</span>
              </div>
            </div>
          </header>

          <div className="fb-layout">
            {/* Left Sidebar - Categories as Groups */}
            <aside className="fb-sidebar">
              <div className="sidebar-section">
                <div className="sidebar-title">Grupper</div>
                <div 
                  className={`sidebar-item ${!activeCategoryFilter?'active':''}`}
                  onClick={()=>setCategoryFilter('')}
                >
                  <div className="category-icon" style={{background:'linear-gradient(135deg,#1877F2,#166FE5)'}}>
                    üè†
                  </div>
                  <span className="category-name">Alla inl√§gg</span>
                  <span className="category-count">{posts.length}</span>
                </div>
                {categories.map(cat=>{
                  const catPosts = posts.filter(p=>p.category_id===cat.category_id);
                  return (
                    <div 
                      key={cat.category_id}
                      className={`sidebar-item ${activeCategoryFilter===String(cat.category_id)?'active':''}`}
                      onClick={()=>setCategoryFilter(String(cat.category_id))}
                    >
                      <div className="category-icon" style={{backgroundColor:cat.color||'#6B7280'}}>
                        {cat.name[0]}
                      </div>
                      <span className="category-name">{cat.name}</span>
                      {catPosts.length>0 && <span className="category-count">{catPosts.length}</span>}
                    </div>
                  );
                })}
              </div>
            </aside>

            {/* Main Feed */}
            <main className="fb-feed">
              {/* Create post box */}
              {!hasActiveFilters && (
                <div className="create-box">
                  <div className="create-box-top">
                    <div className="user-avatar">{(session.email||'?')[0].toUpperCase()}</div>
                    <div className="create-input" onClick={()=>setShowCreatePost(true)}>
                      Vad t√§nker du p√•, {session.displayName || firstNameFromEmail(session.email)}?
                    </div>
                  </div>
                </div>
              )}

              {hasActiveFilters && (
                <div className="results-count">
                  {loading ? 'S√∂ker...' : `${resultCount} inl√§gg funna`}
                </div>
              )}

              {/* Posts */}
              {loading ? (
                <Loader text="Laddar inl√§gg..."/>
              ) : posts.length===0 ? (
                <div className="results-count">Inga inl√§gg √§nnu. Var f√∂rst att dela n√•got!</div>
              ) : (
                posts.map(post=>{
                  const isAuthor = String(post.author_email||'').toLowerCase() === String(session.email||'').toLowerCase();
                  return (
                    <article key={post.post_id} className="post-card" onClick={(e)=>openPost(post,e)}>
                      <div className="post-card-header">
                        <div className="post-avatar">{(post.author_email||'?')[0].toUpperCase()}</div>
                        <div className="post-info">
                          <div className="post-author-row">
                            <span className="post-author-name">{firstNameFromEmail(post.author_email)}</span>
                            {post.category && (
                              <span className="post-category-badge" style={{backgroundColor:post.category.color||'#6B7280'}}>
                                {post.category.name}
                              </span>
                            )}
                          </div>
                          <div className="post-timestamp">
                            {new Date(post.created_at).toLocaleString('sv-SE')}
                          </div>
                        </div>
                        {isAuthor && (
                          <div style={{display:'flex',gap:'4px'}}>
                            <button className="post-menu-btn edit-btn" onClick={(e)=>{e.stopPropagation();handleEdit(post);}} title="Redigera">‚úèÔ∏è</button>
                            <button className="post-menu-btn delete-btn" onClick={(e)=>{e.stopPropagation();setPostToDelete(post);setConfirmOpen(true);}} title="Radera">√ó</button>
                          </div>
                        )}
                      </div>

                      <h2 className="post-title">{post.title||'(utan rubrik)'}</h2>
                      <div className="post-content">{summaryOf(post)}</div>

                      <ProgressIndicator progress={post.progress||'planeras'}/>

                      <div className="post-actions" onClick={(e)=>e.stopPropagation()}>
                        <ReactionBar post={post} session={session}/>
                        <button className="post-action-btn">üí¨ {post.comments_count||0}</button>
                      </div>
                    </article>
                  );
                })
              )}
            </main>

            {/* Right Sidebar - Filters */}
            <aside className="fb-right-sidebar">
              <div className="filter-panel">
                <div className="filter-title">Filter</div>
                <div className="filter-group">
                  <label className="filter-label">F√∂rfattare</label>
                  <input 
                    type="text" 
                    className="filter-input" 
                    placeholder="Filtrera efter f√∂rfattare..."
                    value={authorFilter}
                    onChange={(e)=>setAuthorFilter(e.target.value)}
                  />
                </div>
                {hasActiveFilters && (
                  <button className="filter-clear-btn" onClick={clearFilters}>
                    Rensa filter
                  </button>
                )}
              </div>
            </aside>
          </div>

          <CreateEditPostModal 
            isOpen={showCreatePost} 
            onClose={handleCloseModal} 
            session={session} 
            onSuccess={handleSuccess}
            editPost={editingPost}
          />
          <TrashModal isOpen={showTrash} onClose={()=>setShowTrash(false)} session={session} onChanged={()=>loadPosts()}/>
          <PostDetailModal 
            isOpen={showPostDetail} 
            onClose={()=>{setShowPostDetail(false);setSelectedPost(null);}} 
            post={selectedPost} 
            session={session}
            onEdit={handleEdit}
          />
          <InfoModal isOpen={showInfo} onClose={()=>setShowInfo(false)} showEmailInfo={false}/>

          <ConfirmModal
            isOpen={confirmOpen}
            title="Radera inl√§gg?"
            message="Vill du verkligen radera inl√§gget? Det flyttas till papperskorgen och kan √•terst√§llas."
            confirmText="Ja, radera"
            cancelText="Avbryt"
            onConfirm={doDelete}
            onCancel={()=>{setConfirmOpen(false);setPostToDelete(null);}}
          />
        </>
      );
    }

    function App(){
      const [session,setSession] = useState(null);
      const [booting,setBooting] = useState(true);
      
      useEffect(()=>{
        const saved = localStorage.getItem(CONFIG.STORAGE_KEY);
        if (saved) { 
          try { setSession(JSON.parse(saved)); } 
          catch { localStorage.removeItem(CONFIG.STORAGE_KEY); } 
        }
        setBooting(false);
      },[]);
      
      const onLogin = (sess)=>{ 
        setSession(sess); 
        localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(sess)); 
      };
      
      const onLogout = ()=>{ 
        setSession(null); 
        localStorage.removeItem(CONFIG.STORAGE_KEY); 
      };
      
      if (booting) return <Loader text="Startar..."/>;
      if (!session) return <LoginPage onLogin={onLogin}/>;
      return <MainPage session={session} onLogout={onLogout}/>;
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App/>);
  </script>
</body>
</html>
